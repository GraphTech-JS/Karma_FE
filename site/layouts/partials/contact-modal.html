<div id="contactModal" class="hidden modal-overlay" role="dialog" aria-modal="true" aria-labelledby="contactModalTitle">
  <div class="modal-container">
    <div class="modal-content">
      <!-- Close Button -->
      <button class="cursor-pointer modal-close" id="closeModal" aria-label="Close modal">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round" />
        </svg>
      </button>
      <!-- Modal Header -->
      <div class="modal-header">
        <h2 id="contactModalTitle" class="modal-title font-['Unbounded']">
          <span class="title-highlight">З</span>алиште свій запит і ми
          зв'яжемось з Вами <br /> та повідомимо про актуальні ціни
        </h2>
      </div>
      <div class="toast-stack" id="toastStack" aria-live="polite" aria-atomic="true"></div>
      <!-- Contact Form -->
      <form class="contact-form" id="contactForm" novalidate>
        <div class="form-row">
          <div class="form-group">
            <input type="text" id="userName" name="userName" placeholder="Ваше ім'я" class="form-input" required />
          </div>
          <div class="form-group">
            <input type="tel" id="userPhone" name="userPhone" placeholder="+380" class="form-input" inputmode="tel"
              autocomplete="tel" required />
          </div>
        </div>

        <div class="form-group">
          <div class="custom-dropdown" id="quantityDropdown" role="button" aria-haspopup="listbox" aria-expanded="false"
            tabindex="0">
            <div class="dropdown-selected" id="quantitySelected">
              <span class="placeholder">Кількість стеків, яку плануєте замовити</span>
            </div>
            <div class="dropdown-options" id="quantityOptions" role="listbox" tabindex="-1">
              <div class="dropdown-option" role="option" data-value="0-20">0 - 20</div>
              <div class="dropdown-option" role="option" data-value="20-100">20 - 100</div>
              <div class="dropdown-option" role="option" data-value="100-1000">100 - 1 000</div>
              <div class="dropdown-option" role="option" data-value="3000-10000">3 000 - 10 000</div>
              <div class="dropdown-option" role="option" data-value="10000+">>10 000</div>
            </div>
            <input type="hidden" id="quantity" name="quantity" required />
          </div>
        </div>

        <div class="form-group">
          <textarea id="message" name="message" placeholder="Ваше повідомлення" class="form-textarea"
            rows="4"></textarea>
        </div>

        <div class="contact-info">
          <div class="contact-wrapper">
            <p class="contact-label">Наші контакти для зв'язку:</p>
            <div class="contact-details">
              <a href="tel:+380956156713" class="contact-phone"> +380 95 61 56713 </a>
              <a href="mailto:info@karma.flights" class="contact-email"> info@karma.flights </a>
            </div>
          </div>
          <button type="submit" class="cursor-pointer submit-button-modal">Відправити</button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
  .toast-stack {
    position: absolute;
    top: 12px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 2000;
    display: flex;
    flex-direction: column;
    gap: 8px;
    align-items: center;
    width: min(92%, 560px);
    pointer-events: none;

  }

  .toast {
    pointer-events: auto;
    border-radius: 10px;
    padding: 12px 16px !important;
    border: 1px solid;
    font-family: 'Montserrat', sans-serif;
    font-size: clamp(14px, 1.6vw, 16px);
    font-weight: 400;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.18);
    opacity: 0;
    max-width: 400px !important;
    width: 100% !important;
    transform: translateY(-8px) !important;
    text-align: center !important;
    transition: opacity 200ms ease, transform 200ms ease;
    white-space: pre-line !important;
  }

  .toast--show {
    opacity: 1;
    transform: translateY(0) !important;
  }

  .toast--error {
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%) !important;
    color: #fff !important;
    border-color: transparent !important;
  }

 .toast--success {
  background: linear-gradient(135deg, #16a34a 0%, #15803d 100%) !important;
  color: #fff !important;
  border-color: transparent !important;
}

  /* Custom Dropdown Styles */
  .custom-dropdown {
    position: relative;
    display: flex;
    width: 100%;
    padding: 16px 20px !important;
    border: 1px solid #404040 !important;
    border-radius: 5px !important;
    font-family: 'Montserrat', sans-serif;
    font-weight: 400;
    color: black;
    background: #f0f1f5;
    box-sizing: border-box;
    transition: border-color 0.3s ease, border-radius 0.3s ease;
    cursor: pointer;
    height: 65px;
  }

  .custom-dropdown span {
    font-size: clamp(16px, 2vw, 20px);
  }

  .custom-dropdown.dropdown-open {
    border-radius: 5px 5px 0 0 !important;
    border-bottom-color: transparent;
  }

  .submit-button-modal {
    background: #ba0108 !important;
    font-size: clamp(16px, 2vw, 20px) !important;
    font-family: 'Montserrat', sans-serif !important;
    font-weight: 400 !important;
    color: #fefefe !important;
    padding: 14px 54px !important;
    height: 70px !important;
    width: 465px !important;
    cursor: pointer !important;
    border-radius: 20px !important;
    transition: background-color 0.2s ease !important;
  }

  .submit-button-modal:hover {
    background: #e39599 !important;
  }

  .submit-button-modal:active {
    transform: translateY(1px) !important;
  }

  .submit-button-modal:disabled {
    opacity: 0.7;
    cursor: not-allowed !important;
  }

  .dropdown-selected {
    padding: 12px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    font-weight: 400;
    font-family: 'Montserrat', sans-serif;
    align-items: center;
    font-size: 14px;
    color: #7e7e7e;
    transition: all 0.2s ease;
    width: 100%;
    pointer-events: none;
  }

  .dropdown-selected .placeholder {
    color: #999;
    width: 100%;
    text-align: left;
  }

  .dropdown-options {
    position: absolute;
    top: 102%;
    left: -1px;
    right: -1px;
    background: #eaeaec;
    border: 1px solid #404040;
    border-top: none;
    max-height: 0;
    overflow: hidden;
    z-index: 100;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition:
      max-height 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94),
      opacity 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94),
      transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94),
      visibility 0.5s ease;
    width: calc(100% + 2px);
  }

  .dropdown-options.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .dropdown-option {
    cursor: pointer;
    transition: background-color 0.2s ease;
    font-size: 14px;
    font-weight: 400;
    font-family: 'Montserrat', sans-serif;
    color: #333;
    padding: 20px 34px !important;
    text-align: center;
    background: #eaeaec;
    border-bottom: 1px solid rgba(64, 64, 64, 0.1);
  }

  .dropdown-option:hover {
    background: #d8d8d8;
  }

  .custom-dropdown:hover {
    border-color: #666;
  }

  .custom-dropdown.dropdown-open:hover {
    border-color: #404040;
  }

  .form-input.input-error,
  .custom-dropdown.input-error,
  .form-textarea.input-error {
    border-color: #ba0108 !important;
    box-shadow: 0 0 0 2px rgba(195, 51, 51, 0.08);
    background: #fff6f6;
  }

   @media (max-width: 1200px) {
    .submit-button-modal {
      width: 322px !important;
    }
  }

  @media (max-width: 1000px) {
    .contact-info {
      flex-direction: column;
      align-items: flex-start;
    }

    .submit-button-modal {
      width: 100% !important;
    }
  }

  @media (max-width: 768px) {
    .custom-dropdown {
      display: flex;
      padding: 14px 16px !important;
    }

    .dropdown-selected {
      font-size: 14px;
      padding: 8px;
    }

    .dropdown-options {
      max-height: 0;
    }

    .dropdown-options.show {
      max-height: 320px;
    }

    .dropdown-option {
      font-size: 14px;
      padding: 12px 16px !important;
    }

    .submit-button-modal {
      width: 400px !important;
      height: 70px !important;
    }
  }

  @media (min-width: 769px) and (max-width: 1023px) {
    .dropdown-options.show {
      max-height: 340px;
    }
  }

  @media (min-width: 1024px) {
    .dropdown-selected {
      font-size: 16px;
    }

    .dropdown-option {
      font-size: 16px;
    }

    .dropdown-options.show {
      max-height: 360px;
    }
  }

  @media (max-width: 480px) {
    .custom-dropdown {
      display: flex;
      padding: 14px 16px !important;
    }

    .dropdown-selected {
      padding: 8px;
    }

    .dropdown-selected span {
      font-size: 14px;
    }

    .dropdown-options {
      max-height: 0;
    }

    .dropdown-options.show {
      max-height: 320px;
    }

    .dropdown-option {
      font-size: 14px;
      padding: 12px 16px !important;
    }

    .submit-button-modal {
      width: 350px !important;
      height: 65px !important;
      border-radius: 5px !important;
      padding: 0 !important;
    }
  }

  /* Focus and accessibility improvements */
  .custom-dropdown:focus-within {
    outline: 2px solid #4A90E2;
    outline-offset: 2px;
  }

  .dropdown-option:focus {
    background: #d0d0d0;
    outline: none;
  }
</style>

<script>
  (function () {
    let modalInstance = null;

    class ContactModal {
      constructor() {
        this.modal = document.getElementById('contactModal');
        this.openBtn = document.getElementById('openModal');
        this.closeBtn = document.getElementById('closeModal');
        this.form = document.getElementById('contactForm');

        this.quantityDropdown = document.getElementById('quantityDropdown');
        this.quantitySelected = document.getElementById('quantitySelected');
        this.quantityOptions = document.getElementById('quantityOptions');
        this.quantityInput = document.getElementById('quantity');

        this.toastStack = document.getElementById('toastStack');

        this.phoneInput = document.getElementById('userPhone');

        this.init();
      }

      init() {
        if (!this.modal) return;

        if (this.openBtn) this.openBtn.addEventListener('click', () => this.open());
        if (this.closeBtn) this.closeBtn.addEventListener('click', () => this.close());

        this.modal.addEventListener('click', (e) => {
          if (e.target === this.modal) this.close();
        });

        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && !this.modal.classList.contains('hidden')) this.close();
        });

        if (this.form) {
          this.form.addEventListener('submit', (e) => this.handleSubmit(e));
        }

        if (this.phoneInput) {
          this.phoneInput.addEventListener('input', (e) => this.formatPhoneInput(e));
          this.phoneInput.addEventListener('focus', (e) => this.onPhoneFocus(e));
          this.phoneInput.addEventListener('blur', (e) => this.onPhoneBlur(e));
        }

        this.initDropdown();
      }

      /* ========== Dropdown ========== */
      initDropdown() {
        if (!this.quantityDropdown) return;

        this.quantityDropdown.addEventListener('click', (e) => {
          e.stopPropagation();
          this.toggleDropdown();
        });

        this.quantityOptions.addEventListener('click', (e) => {
          if (e.target.classList.contains('dropdown-option')) {
            e.stopPropagation();
            this.selectOption(e.target);
          }
        });

        document.addEventListener('click', (e) => {
          if (!this.quantityDropdown.contains(e.target)) this.closeDropdown();
        });

        this.quantityDropdown.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            this.toggleDropdown();
          } else if (e.key === 'Escape') {
            this.closeDropdown();
          }
        });

        this.quantityDropdown.setAttribute('tabindex', '0');
      }

      toggleDropdown() {
        const isOpen = this.quantityOptions.classList.contains('show');
        if (isOpen) this.closeDropdown();
        else this.openDropdown();
      }

      openDropdown() {
        const optionHeight = this.getOptionHeight();
        const optionsCount = this.quantityOptions.children.length;
        const totalHeight = optionHeight * optionsCount;

        this.quantityDropdown.classList.add('dropdown-open');
        this.quantityDropdown.setAttribute('aria-expanded', 'true');

        requestAnimationFrame(() => {
          this.quantityOptions.style.maxHeight = totalHeight + 'px';
          this.quantityOptions.classList.add('show');
        });

        const firstOption = this.quantityOptions.querySelector('.dropdown-option');
        if (firstOption) setTimeout(() => firstOption.focus(), 150);
      }

      closeDropdown() {
        this.quantityOptions.classList.remove('show');
        this.quantityDropdown.setAttribute('aria-expanded', 'false');

        requestAnimationFrame(() => {
          this.quantityOptions.style.maxHeight = '0px';
        });

        setTimeout(() => {
          this.quantityDropdown.classList.remove('dropdown-open');
        }, 300);
      }

      getOptionHeight() {
        if (window.innerWidth <= 768) return 64;
        else if (window.innerWidth <= 1023) return 68;
        else return 72;
      }

      selectOption(option) {
        const value = option.dataset.value;
        const text = option.textContent;

        this.quantitySelected.querySelector('span').textContent = text;
        this.quantitySelected.querySelector('span').classList.remove('placeholder');
        this.quantityInput.value = value;

        this.closeDropdown();

        setTimeout(() => this.quantityDropdown.focus(), 250);
      }

      resetDropdown() {
        this.quantitySelected.querySelector('span').textContent = 'Кількість стеків, яку плануєте замовити';
        this.quantitySelected.querySelector('span').classList.add('placeholder');
        this.quantityInput.value = '';
        this.closeDropdown();
      }

      open() {
        this.modal.classList.remove('hidden');
        document.body.classList.add('modal-open');

        const firstInput = this.modal.querySelector('.form-input');
        if (firstInput) setTimeout(() => firstInput.focus(), 100);
      }

      close() {
        this.clearToasts();
        this.modal.classList.add('hidden');
        document.body.classList.remove('modal-open');

        if (this.form) {
          this.form.reset();
          this.resetDropdown();
          this.clearFieldErrors();
        }
      }

      formatPhoneInput(e) {
        const input = e.target;
        const raw = input.value || '';
        const trimmed = raw.trim();
        const hasLeadingPlus = trimmed.startsWith('+');

        let digits = raw.replace(/\D/g, '');

        if (digits.length === 0) {
          input.value = hasLeadingPlus ? '' : '';
          return;
        }

        if (hasLeadingPlus) {
          if (digits.startsWith('380')) {
            const d = digits.slice(0, 12);
            const rest = d.slice(3);

            let formatted = '+380';
            if (rest.length > 0) {
              const a = rest.slice(0, 2);
              const b = rest.slice(2, 5);
              const c = rest.slice(5, 7);
              const d4 = rest.slice(7, 9);
              if (a) formatted += ' ' + a;
              if (b) formatted += ' ' + b;
              if (c) formatted += ' ' + c;
              if (d4) formatted += ' ' + d4;
            }
            input.value = formatted;
          } else {
            input.value = '+' + digits.slice(0, 15);
          }
          return;
        }

        if (digits.startsWith('0')) {
          const d = digits.slice(0, 10);
          const first = d.charAt(0);
          const rest = d.slice(1);
          let formatted = first;
          if (rest.length > 0) {
            const a = rest.slice(0, 2);
            const b = rest.slice(2, 5);
            const c = rest.slice(5, 7);
            const d4 = rest.slice(7, 9);
            if (a) formatted += a;
            if (b) formatted += ' ' + b;
            if (c) formatted += ' ' + c;
            if (d4) formatted += ' ' + d4;
          }
          input.value = formatted;
          return;
        }

        input.value = digits.slice(0, 12);
      }

      onPhoneFocus(e) {
        const input = e.target;
        if ((input.value || '').trim() === '') {
          input.value = '+380 ';
          try {
            const pos = input.value.length;
            input.setSelectionRange(pos, pos);
          } catch (_) { }
        }
      }

      onPhoneBlur(e) {
        const input = e.target;
        const raw = (input.value || '').trim();
        const digits = raw.replace(/\D/g, '');
        const startsWithPlus = raw.startsWith('+');


        if (startsWithPlus) {
          if (digits.length < 4 || (digits.startsWith('380') && digits.length === 3)) {
            input.value = '';
            return;
          }
        }

        this.formatPhoneInput({ target: input });
      }

      normalizePhoneToUA(value) {
        const digits = (value || '').replace(/\D/g, '');

        if (digits.length === 12 && digits.startsWith('380')) {
          return '+' + digits;
        }

        if (digits.length === 10 && digits.startsWith('0')) {
          return '+38' + digits;
        }

        return null;
      }

      handleSubmit(e) {
        e.preventDefault();
        this.clearFieldErrors();

        const formData = new FormData(this.form);
        const data = {
          name: (formData.get('userName') || '').trim(),
          phoneRaw: (formData.get('userPhone') || '').trim(),
          quantity: (formData.get('quantity') || '').trim(),
          message: (formData.get('message') || '').trim(),
        };

        let hasError = false;
        if (!data.name) {
          this.markFieldError('#userName');
          this.showError("Будь ласка, введіть ваше ім'я");
          hasError = true;
        }

        const normalizedPhone = this.normalizePhoneToUA(data.phoneRaw);
        if (!normalizedPhone) {
          this.markFieldError('#userPhone');
          this.showError('Будь ласка, введіть коректний номер телефону');
          hasError = true;
        }

        if (!data.quantity) {
          this.markDropdownError();
          this.showError('Будь ласка, оберіть кількість стеків');
          hasError = true;
        }

        if (hasError) return;

        const payload = {
          name: data.name,
          phone: normalizedPhone,
          quantity: data.quantity,
          message: data.message,
        };

        this.submitForm(payload);
      }

      async submitForm(data) {
        const submitBtn = this.form.querySelector('.submit-button-modal');
        const originalText = submitBtn.textContent;

        submitBtn.textContent = 'Відправляємо...';
        submitBtn.disabled = true;

        try {
          await new Promise((resolve) => setTimeout(resolve, 1200));

          await this.showSuccess(
            "Дякуємо! Ваш запит успішно відправлено. Ми зв'яжемось з вами найближчим часом.");

          this.close();
        } catch (error) {
          this.showError('Виникла помилка при відправці. Спробуйте ще раз.');
        } finally {
          submitBtn.textContent = originalText;
          submitBtn.disabled = false;
        }
      }

      clearToasts() {
        if (!this.toastStack) return;
        this.toastStack.innerHTML = '';
      }

      showToast(message, type = 'success', autoHideMs = 2000) {
        if (!this.toastStack) return Promise.resolve();

        const toast = document.createElement('div');
        toast.className = `toast toast--${type}`;
        toast.textContent = message;
        this.toastStack.appendChild(toast);

        requestAnimationFrame(() => toast.classList.add('toast--show'));

        const wait = Math.max(1200, autoHideMs);

        return new Promise((resolve) => {
          setTimeout(() => {
            toast.classList.remove('toast--show');
            setTimeout(() => {
              toast.remove();
              resolve();
            }, 220);
          }, wait);
        });
      }

      showError(message) {
        return this.showToast(message, 'error', 4000);
      }

      showSuccess(message) {
        return this.showToast(message, 'success', 2000);
      }

      markFieldError(selector) {
        const el = this.form.querySelector(selector);
        if (el) el.classList.add('input-error');
      }
      markDropdownError() {
        this.quantityDropdown.classList.add('input-error');
      }
      clearFieldErrors() {
        this.form.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));
      }
    }

    window.openContactModal = function () {
      if (!modalInstance) {
        modalInstance = new ContactModal();
      }
      modalInstance.open();
    };

    function initModal() {
      if (!modalInstance && document.getElementById('contactModal')) {
        modalInstance = new ContactModal();
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initModal);
    } else {
      initModal();
    }
  })();
</script>