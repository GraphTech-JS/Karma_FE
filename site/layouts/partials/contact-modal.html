<div id="contactModal" class="hidden modal-overlay">
  <div class="modal-container">
    <div class="modal-content">
      <!-- Close Button -->
      <button class="cursor-pointer modal-close" id="closeModal" aria-label="Close modal">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round" />
        </svg>
      </button>

      <!-- Modal Header -->
      <div class="modal-header">
        <h2 class="modal-title font-['Unbounded']">
          <span class="title-highlight">З</span>алиште свій запит і ми зв'яжемось з Вами
          <br />
          та повідомимо про актуальні ціни
        </h2>
      </div>

      <!-- Contact Form -->
      <form class="contact-form" id="contactForm">
        <div class="form-row">
          <div class="form-group">
            <input type="text" id="userName" name="userName" placeholder="Ваше ім'я" class="form-input" required />
          </div>
          <div class="form-group">
            <input type="tel" id="userPhone" name="userPhone" placeholder="+380" class="form-input" required />
          </div>
        </div>

        <div class="dropdown-group">
          <div class="custom-dropdown form-input" id="quantityDropdown">
            <div class="dropdown-selected" id="quantitySelected">
              <span class="placeholder">Кількість стеків, яку плануєте замовити</span>
            </div>

          </div>
          <input type="hidden" id="quantity" name="quantity" required />
        </div>

        <div class="dropdown-options" id="quantityOptions">
          <div class="dropdown-option" data-value="0-20">0 - 20</div>
          <div class="dropdown-option" data-value="20-100">20 - 100</div>
          <div class="dropdown-option" data-value="100-1000">100 - 1 000</div>
          <div class="dropdown-option" data-value="3000-10000">3 000 - 10 000</div>
          <div class="dropdown-option" data-value="10000+">>10 000</div>
        </div>

        <div class="form-group">
          <textarea id="message" name="message" placeholder="Ваше повідомлення" class="form-textarea"
            rows="4"></textarea>
        </div>
        <div class="contact-info">
          <div class="contact-wrapper">
            <p class="contact-label">Наші контакти для зв'язку:</p>
            <div class="contact-details">
              <a href="tel:+380956156713" class="contact-phone">
                +380 95 61 56713
              </a>
              <a href="mailto:info@karma.flights" class="contact-email">
                info@karma.flights
              </a>
            </div>
          </div>
          <button type="submit" class="cursor-pointer submit-button">
            Відправити
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
  .custom-dropdown {
    position: relative;
    width: 100%;
    background: #eaeaec;
  }

  .dropdown-selected {
    padding: 12px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    font-weight: 400;
    font-family: 'Montserrat', sans-serif;
    align-items: center;
    font-size: 14px;
    color: #7e7e7e;
    transition: all 0.2s ease;
    width: 100%;

  }

  .dropdown-selected:hover {
    border-color: #bbb;
  }

  .dropdown-selected .placeholder {
    color: #999;
    width: 100%;
    text-align: left;
  }

  .dropdown-options {
    position: relative;
    top: auto;
    left: auto;
    right: auto;
    transform: none;
    opacity: 1;
    visibility: visible;
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
    background: #f0f1f5;
  }

  .dropdown-options.show {
    max-height: 280px;
  }

  .dropdown-option {
    padding: 16px 20px;
    cursor: pointer;
    transition: background-color 0.2s ease;
    font-size: 14px;
    font-weight: 400;
    font-family: 'Montserrat', sans-serif;
    color: #333;
    padding: 15px 34px !important;
    text-align: center;
    background: #f0f1f5;
  }

  .dropdown-option:hover {
    background: #d8d8d8;
  }



  @media (max-width: 768px) {
    .custom-dropdown {
      display: flex;
    }

    .dropdown-selected {
      font-size: 14px;
      padding: 10px;
    }

    .dropdown-options {
      padding: 12px 20px;
    }

    .dropdown-option {
      font-size: 14px;
      padding: 12px 16px;
    }
  }

  @media (min-width: 1024px) {
    .dropdown-selected {
      font-size: 16px;
    }

    .dropdown-option {
      font-size: 16px;
    }
  }
</style>

<script>
  // Inline modal functionality to ensure it's always available
  (function () {
    let modalInstance = null;

    class ContactModal {
      constructor() {
        this.modal = document.getElementById('contactModal');
        this.openBtn = document.getElementById('openModal');
        this.closeBtn = document.getElementById('closeModal');
        this.form = document.getElementById('contactForm');
        this.scrollTop = 0;

        // Dropdown elements
        this.quantityDropdown = document.getElementById('quantityDropdown');
        this.quantitySelected = document.getElementById('quantitySelected');
        this.quantityOptions = document.getElementById('quantityOptions');
        this.quantityInput = document.getElementById('quantity');

        this.init();
      }

      init() {
        if (!this.modal) return;

        if (this.openBtn) {
          this.openBtn.addEventListener('click', () => this.open());
        }

        if (this.closeBtn) {
          this.closeBtn.addEventListener('click', () => this.close());
        }

        this.modal.addEventListener('click', (e) => {
          if (e.target === this.modal) {
            this.close();
          }
        });

        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && !this.modal.classList.contains('hidden')) {
            this.close();
          }
        });

        if (this.form) {
          this.form.addEventListener('submit', (e) => this.handleSubmit(e));
        }

        const phoneInput = document.getElementById('userPhone');
        if (phoneInput) {
          phoneInput.addEventListener('input', (e) =>
            this.formatPhoneNumber(e)
          );
        }

        this.initDropdown();
      }

      initDropdown() {
        if (!this.quantityDropdown) return;

        this.quantitySelected.addEventListener('click', (e) => {
          e.stopPropagation();
          this.toggleDropdown();
        });

        this.quantityOptions.addEventListener('click', (e) => {
          if (e.target.classList.contains('dropdown-option')) {
            this.selectOption(e.target);
          }
        });

        document.addEventListener('click', (e) => {
          if (!this.quantityDropdown.contains(e.target)) {
            this.closeDropdown();
          }
        });
      }

      toggleDropdown() {
        const isOpen = this.quantityOptions.classList.contains('show');
        if (isOpen) {
          this.closeDropdown();
        } else {
          this.openDropdown();
        }
      }

      openDropdown() {
        this.quantityOptions.classList.add('show');
        this.quantitySelected.classList.add('active');
      }

      closeDropdown() {
        this.quantityOptions.classList.remove('show');
        this.quantitySelected.classList.remove('active');
      }

      selectOption(option) {
        const value = option.dataset.value;
        const text = option.textContent;

        this.quantitySelected.querySelector('span').textContent = text;
        this.quantitySelected.querySelector('span').classList.remove('placeholder');

        this.quantityInput.value = value;

        this.closeDropdown();

        if (value === 'other') {
          const customQuantity = prompt('Введіть бажану кількість стеків:');
          if (customQuantity && !isNaN(customQuantity) && customQuantity > 0) {
            this.quantityInput.value = customQuantity;
            this.quantitySelected.querySelector('span').textContent = `${customQuantity} стеків`;
          } else {
            this.resetDropdown();
          }
        }
      }

      resetDropdown() {
        this.quantitySelected.querySelector('span').textContent = 'Кількість стеків, яку плануєте замовити';
        this.quantitySelected.querySelector('span').classList.add('placeholder');
        this.quantityInput.value = '';
      }

      open() {
        this.scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        document.documentElement.style.setProperty('--scroll-top', `-${this.scrollTop}px`);

        this.modal.classList.remove('hidden');
        document.documentElement.classList.add('modal-open');
        document.body.classList.add('modal-open');

        document.addEventListener('wheel', this.preventScroll, { passive: false });
        document.addEventListener('touchmove', this.preventScroll, { passive: false });
        document.addEventListener('scroll', this.preventScroll, { passive: false });
        document.addEventListener('keydown', this.preventScroll, { passive: false });

        const firstInput = this.modal.querySelector('.form-input');
        if (firstInput) {
          setTimeout(() => firstInput.focus(), 100);
        }
      }

      close() {
        this.modal.classList.add('hidden');
        document.documentElement.classList.remove('modal-open');
        document.body.classList.remove('modal-open');

        document.documentElement.style.removeProperty('--scroll-top');

        document.removeEventListener('wheel', this.preventScroll, { passive: false });
        document.removeEventListener('touchmove', this.preventScroll, { passive: false });
        document.removeEventListener('scroll', this.preventScroll, { passive: false });
        document.removeEventListener('keydown', this.preventScroll, { passive: false });

        window.scrollTo(0, this.scrollTop);

        if (this.form) {
          this.form.reset();
          this.resetDropdown();
        }

        this.closeDropdown();
      }

      preventScroll = (e) => {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }

      formatPhoneNumber(e) {
        let value = e.target.value.replace(/\D/g, '');

        if (value && !value.startsWith('380')) {
          if (value.startsWith('0')) {
            value = '38' + value;
          } else if (value.length > 0) {
            value = '380' + value;
          }
        }

        if (value.length >= 3) {
          let formatted = '+' + value.substring(0, 3);
          if (value.length > 3) {
            formatted += ' ' + value.substring(3, 5);
          }
          if (value.length > 5) {
            formatted += ' ' + value.substring(5, 8);
          }
          if (value.length > 8) {
            formatted += ' ' + value.substring(8, 10);
          }
          if (value.length > 10) {
            formatted += ' ' + value.substring(10, 12);
          }
          e.target.value = formatted;
        } else if (value.length === 0) {
          e.target.value = '+380';
        }
      }

      handleSubmit(e) {
        e.preventDefault();

        const formData = new FormData(this.form);
        const data = {
          name: formData.get('userName'),
          phone: formData.get('userPhone'),
          quantity: formData.get('quantity'),
          message: formData.get('message'),
        };
        if (!data.name.trim()) {
          this.showError("Будь ласка, введіть ваше ім'я");
          return;
        }

        if (!data.phone.trim() || data.phone.length < 13) {
          this.showError('Будь ласка, введіть коректний номер телефону');
          return;
        }

        if (!data.quantity || data.quantity <= 0) {
          this.showError('Будь ласка, оберіть кількість стеків');
          return;
        }

        this.submitForm(data);
      }

      async submitForm(data) {
        const submitBtn = this.form.querySelector('.submit-button');
        const originalText = submitBtn.textContent;

        submitBtn.textContent = 'Відправляємо...';
        submitBtn.disabled = true;

        try {
          await new Promise((resolve) => setTimeout(resolve, 1500));

          this.showSuccess(
            "Дякуємо! Ваш запит успішно відправлено. Ми зв'яжемось з вами найближчим часом."
          );

          setTimeout(() => {
            this.close();
          }, 2000);
        } catch (error) {
          this.showError('Виникла помилка при відправці. Спробуйте ще раз.');
        } finally {
          submitBtn.textContent = originalText;
          submitBtn.disabled = false;
        }
      }

      showError(message) {
        this.showMessage(message, 'error');
      }

      showSuccess(message) {
        this.showMessage(message, 'success');
      }

      showMessage(message, type) {
        const existingMessage = this.modal.querySelector('.form-message');
        if (existingMessage) {
          existingMessage.remove();
        }

        const messageEl = document.createElement('div');
        messageEl.className = `form-message form-message--${type}`;
        messageEl.textContent = message;

        const submitBtn = this.form.querySelector('.submit-button');
        submitBtn.parentNode.insertBefore(messageEl, submitBtn);

        setTimeout(() => {
          if (messageEl.parentNode) {
            messageEl.remove();
          }
        }, 5000);
      }
    }

    window.openContactModal = function () {
      if (!modalInstance) {
        modalInstance = new ContactModal();
      }
      modalInstance.open();
    };

    function initModal() {
      if (!modalInstance && document.getElementById('contactModal')) {
        modalInstance = new ContactModal();
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initModal);
    } else {
      initModal();
    }
  })();
</script>