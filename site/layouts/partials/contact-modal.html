<div id="contactModal" class="hidden modal-overlay">
  <div class="modal-container">
    <div class="modal-content">
      <!-- Close Button -->
      <button class="cursor-pointer modal-close" id="closeModal" aria-label="Close modal"> <svg width="24" height="24"
          viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"
            stroke-linejoin="round" />
        </svg> </button>
      <!-- Modal Header -->
      <div class="modal-header">
        <h2 class="modal-title font-['Unbounded']"> <span class="title-highlight">З</span>алиште свій запит і ми
          зв'яжемось з Вами <br /> та повідомимо про актуальні ціни </h2>
      </div>
      <!-- Contact Form -->
      <form class="contact-form" id="contactForm">
        <div class="form-row">
          <div class="form-group"> <input type="text" id="userName" name="userName" placeholder="Ваше ім'я"
              class="form-input" required /> </div>
          <div class="form-group"> <input type="tel" id="userPhone" name="userPhone" placeholder="+380"
              class="form-input" required /> </div>
        </div>
        <div class="form-group">
          <div class="custom-dropdown" id="quantityDropdown">
            <div class="dropdown-selected" id="quantitySelected"> <span class="placeholder">Кількість стеків, яку
                плануєте замовити</span> </div>
            <div class="dropdown-options" id="quantityOptions">
              <div class="dropdown-option" data-value="0-20">0 - 20</div>
              <div class="dropdown-option" data-value="20-100">20 - 100</div>
              <div class="dropdown-option" data-value="100-1000">100 - 1 000</div>
              <div class="dropdown-option" data-value="3000-10000">3 000 - 10 000</div>
              <div class="dropdown-option" data-value="10000+">>10 000</div>
            </div>
            <input type="hidden" id="quantity" name="quantity" required />
          </div>
        </div>

        <div class="form-group"> <textarea id="message" name="message" placeholder="Ваше повідомлення"
            class="form-textarea" rows="4"></textarea> </div>
        <div class="contact-info">
          <div class="contact-wrapper">
            <p class="contact-label">Наші контакти для зв'язку:</p>
            <div class="contact-details"> <a href="tel:+380956156713" class="contact-phone"> +380 95 61 56713 </a> <a
                href="mailto:info@karma.flights" class="contact-email"> info@karma.flights </a> </div>
          </div> <button type="submit" class="cursor-pointer submit-button"> Відправити </button>
        </div>
      </form>
    </div>
  </div>
</div>
<style>
  /* Custom Dropdown Styles */
  .custom-dropdown {
    position: relative;
    display: flex;
    width: 100%;
    padding: 16px 20px !important;
    border: 1px solid #404040 !important;
    border-radius: 5px !important;
    font-family: 'Montserrat', sans-serif;
    font-size: clamp(16px, 2vw, 20px);
    font-weight: 400;
    color: black;
    background: #f0f1f5;
    box-sizing: border-box;
    transition: border-color 0.3s ease, border-radius 0.3s ease;
    cursor: pointer;
    height: 65px;
  }

  /* Dropdown open state - remove bottom border radius */
  .custom-dropdown.dropdown-open {
    border-radius: 5px 5px 0 0 !important;
    border-bottom-color: transparent;
  }

  .dropdown-selected {
    padding: 12px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    font-weight: 400;
    font-family: 'Montserrat', sans-serif;
    align-items: center;
    font-size: 14px;
    color: #7e7e7e;
    transition: all 0.2s ease;
    width: 100%;
    pointer-events: none;
  }

  .dropdown-selected:hover {
    border-color: #bbb;
  }

  .dropdown-selected .placeholder {
    color: #999;
    width: 100%;
    text-align: left;
  }

  .dropdown-options {
    position: absolute;
    top: 102%;
    left: -1px;
    right: -1px;
    background: #eaeaec;
    border: 1px solid #404040;
    border-top: none;
    max-height: 0;
    overflow: hidden;
    z-index: 100;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition:
      max-height 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94),
      opacity 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94),
      transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94),
      visibility 0.5s ease;
    width: calc(100% + 2px);
  }

  .dropdown-options.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .dropdown-option {
    cursor: pointer;
    transition: background-color 0.2s ease;
    font-size: 14px;
    font-weight: 400;
    font-family: 'Montserrat', sans-serif;
    color: #333;
    padding: 20px 34px !important;
    text-align: center;
    background: #eaeaec;
    border-bottom: 1px solid rgba(64, 64, 64, 0.1);
  }

  .dropdown-option:hover {
    background: #d8d8d8;
  }

  /* Animation improvements */
  .custom-dropdown:hover {
    border-color: #666;
  }

  .custom-dropdown.dropdown-open:hover {
    border-color: #404040;
  }

  /* Form message styles for better UX */
  .form-message {
    padding: 12px 16px;
    border-radius: 6px;
    margin: 10px 0;
    font-size: 14px;
    font-family: 'Montserrat', sans-serif;
    animation: slideIn 0.3s ease;
  }

  .form-message--error {
    background-color: #fee;
    color: #c33;
    border: 1px solid #fcc;
  }

  .form-message--success {
    background-color: #efe;
    color: #363;
    border: 1px solid #cfc;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @media (max-width: 768px) {
    .custom-dropdown {
      display: flex;
      padding: 14px 16px !important;
    }

    .dropdown-selected {
      font-size: 14px;
      padding: 8px;
    }

    .dropdown-options {
      max-height: 0;
    }

    .dropdown-options.show {
      max-height: 320px;
    }

    .dropdown-option {
      font-size: 14px;
      padding: 12px 16px !important;
    }
  }

  /* Tablet styles */
  @media (min-width: 769px) and (max-width: 1023px) {
    .dropdown-options.show {
      max-height: 340px;
    }
  }

  /* Desktop styles */
  @media (min-width: 1024px) {
    .dropdown-selected {
      font-size: 16px;
    }

    .dropdown-option {
      font-size: 16px;
    }

    .dropdown-options.show {
      max-height: 360px;
    }
  }

  /* Focus and accessibility improvements */
  .custom-dropdown:focus-within {
    outline: 2px solid #4A90E2;
    outline-offset: 2px;
  }

  .dropdown-option:focus {
    background: #d0d0d0;
    outline: none;
  }
</style>

<script>
  // Inline modal functionality to ensure it's always available
  (function () {
    let modalInstance = null;

    class ContactModal {
      constructor() {
        this.modal = document.getElementById('contactModal');
        this.openBtn = document.getElementById('openModal');
        this.closeBtn = document.getElementById('closeModal');
        this.form = document.getElementById('contactForm');
        this.scrollTop = 0;

        // Dropdown elements
        this.quantityDropdown = document.getElementById('quantityDropdown');
        this.quantitySelected = document.getElementById('quantitySelected');
        this.quantityOptions = document.getElementById('quantityOptions');
        this.quantityInput = document.getElementById('quantity');

        this.init();
      }

      init() {
        if (!this.modal) return;

        if (this.openBtn) {
          this.openBtn.addEventListener('click', () => this.open());
        }

        if (this.closeBtn) {
          this.closeBtn.addEventListener('click', () => this.close());
        }

        this.modal.addEventListener('click', (e) => {
          if (e.target === this.modal) {
            this.close();
          }
        });

        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && !this.modal.classList.contains('hidden')) {
            this.close();
          }
        });

        if (this.form) {
          this.form.addEventListener('submit', (e) => this.handleSubmit(e));
        }

        const phoneInput = document.getElementById('userPhone');
        if (phoneInput) {
          phoneInput.addEventListener('input', (e) =>
            this.formatPhoneNumber(e)
          );
        }

        this.initDropdown();
      }

      initDropdown() {
        if (!this.quantityDropdown) return;

        // Click handler for entire dropdown container
        this.quantityDropdown.addEventListener('click', (e) => {
          e.stopPropagation();
          this.toggleDropdown();
        });

        this.quantityOptions.addEventListener('click', (e) => {
          if (e.target.classList.contains('dropdown-option')) {
            e.stopPropagation(); // Запобігаємо спливанню події
            this.selectOption(e.target);
          }
        });

        document.addEventListener('click', (e) => {
          if (!this.quantityDropdown.contains(e.target)) {
            this.closeDropdown();
          }
        });

        this.quantityDropdown.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            this.toggleDropdown();
          } else if (e.key === 'Escape') {
            this.closeDropdown();
          }
        });

        this.quantityDropdown.setAttribute('tabindex', '0');
      }

      toggleDropdown() {
        const isOpen = this.quantityOptions.classList.contains('show');
        if (isOpen) {
          this.closeDropdown();
        } else {
          this.openDropdown();
        }
      }

      openDropdown() {
        const optionHeight = this.getOptionHeight();
        const optionsCount = this.quantityOptions.children.length;
        const totalHeight = optionHeight * optionsCount;

        this.quantityDropdown.classList.add('dropdown-open');
        this.quantitySelected.classList.add('active');

        // Використовуємо requestAnimationFrame для плавної анімації
        requestAnimationFrame(() => {
          this.quantityOptions.style.maxHeight = totalHeight + 'px';
          this.quantityOptions.classList.add('show');
        });

        const firstOption = this.quantityOptions.querySelector('.dropdown-option');
        if (firstOption) {
          setTimeout(() => {
            firstOption.focus();
          }, 200);
        }
      }

      closeDropdown() {
        this.quantityOptions.classList.remove('show');
        this.quantitySelected.classList.remove('active');

        // Використовуємо requestAnimationFrame для плавної анімації
        requestAnimationFrame(() => {
          this.quantityOptions.style.maxHeight = '0px';
        });

        // Прибираємо dropdown-open клас з затримкою після завершення анімації
        setTimeout(() => {
          this.quantityDropdown.classList.remove('dropdown-open');
        }, 350); // 350ms = тривалість transition
      }

      getOptionHeight() {
        if (window.innerWidth <= 768) {
          return 64;
        } else if (window.innerWidth <= 1023) {
          return 68;
        } else {
          return 72;
        }
      }

      selectOption(option) {
        const value = option.dataset.value;
        const text = option.textContent;

        this.quantitySelected.querySelector('span').textContent = text;
        this.quantitySelected.querySelector('span').classList.remove('placeholder');
        this.quantityInput.value = value;

        this.closeDropdown();

        if (value === 'other') {
          const customQuantity = prompt('Введіть бажану кількість стеків:');
          if (customQuantity && !isNaN(customQuantity) && customQuantity > 0) {
            this.quantityInput.value = customQuantity;
            this.quantitySelected.querySelector('span').textContent = `${customQuantity} стеків`;
          } else {
            this.resetDropdown();
          }
        }

        setTimeout(() => {
          this.quantityDropdown.focus();
        }, 300);
      }

      resetDropdown() {
        this.quantitySelected.querySelector('span').textContent = 'Кількість стеків, яку плануєте замовити';
        this.quantitySelected.querySelector('span').classList.add('placeholder');
        this.quantityInput.value = '';
        this.closeDropdown();
      }

      open() {
        this.scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        document.documentElement.style.setProperty('--scroll-top', `-${this.scrollTop}px`);

        this.modal.classList.remove('hidden');
        document.documentElement.classList.add('modal-open');
        document.body.classList.add('modal-open');

        document.addEventListener('wheel', this.preventScroll, { passive: false });
        document.addEventListener('touchmove', this.preventScroll, { passive: false });
        document.addEventListener('scroll', this.preventScroll, { passive: false });
        document.addEventListener('keydown', this.preventScroll, { passive: false });

        const firstInput = this.modal.querySelector('.form-input');
        if (firstInput) {
          setTimeout(() => firstInput.focus(), 100);
        }
      }

      close() {
        this.modal.classList.add('hidden');
        document.documentElement.classList.remove('modal-open');
        document.body.classList.remove('modal-open');

        document.documentElement.style.removeProperty('--scroll-top');

        document.removeEventListener('wheel', this.preventScroll, { passive: false });
        document.removeEventListener('touchmove', this.preventScroll, { passive: false });
        document.removeEventListener('scroll', this.preventScroll, { passive: false });
        document.removeEventListener('keydown', this.preventScroll, { passive: false });

        window.scrollTo(0, this.scrollTop);

        if (this.form) {
          this.form.reset();
          this.resetDropdown();
        }

        this.closeDropdown();
      }

      preventScroll = (e) => {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }

      formatPhoneNumber(e) {
        let value = e.target.value.replace(/\D/g, '');

        if (value && !value.startsWith('380')) {
          if (value.startsWith('0')) {
            value = '38' + value;
          } else if (value.length > 0) {
            value = '380' + value;
          }
        }

        if (value.length >= 3) {
          let formatted = '+' + value.substring(0, 3);
          if (value.length > 3) {
            formatted += ' ' + value.substring(3, 5);
          }
          if (value.length > 5) {
            formatted += ' ' + value.substring(5, 8);
          }
          if (value.length > 8) {
            formatted += ' ' + value.substring(8, 10);
          }
          if (value.length > 10) {
            formatted += ' ' + value.substring(10, 12);
          }
          e.target.value = formatted;
        } else if (value.length === 0) {
          e.target.value = '+380';
        }
      }

      handleSubmit(e) {
        e.preventDefault();

        const formData = new FormData(this.form);
        const data = {
          name: formData.get('userName'),
          phone: formData.get('userPhone'),
          quantity: formData.get('quantity'),
          message: formData.get('message'),
        };

        if (!data.name.trim()) {
          this.showError("Будь ласка, введіть ваше ім'я");
          return;
        }

        if (!data.phone.trim() || data.phone.length < 13) {
          this.showError('Будь ласка, введіть коректний номер телефону');
          return;
        }

        if (!data.quantity || data.quantity <= 0) {
          this.showError('Будь ласка, оберіть кількість стеків');
          return;
        }

        this.submitForm(data);
      }

      async submitForm(data) {
        const submitBtn = this.form.querySelector('.submit-button');
        const originalText = submitBtn.textContent;

        submitBtn.textContent = 'Відправляємо...';
        submitBtn.disabled = true;

        try {
          await new Promise((resolve) => setTimeout(resolve, 1500));

          this.showSuccess(
            "Дякуємо! Ваш запит успішно відправлено. Ми зв'яжемось з вами найближчим часом."
          );

          setTimeout(() => {
            this.close();
          }, 2000);
        } catch (error) {
          this.showError('Виникла помилка при відправці. Спробуйте ще раз.');
        } finally {
          submitBtn.textContent = originalText;
          submitBtn.disabled = false;
        }
      }

      showError(message) {
        this.showMessage(message, 'error');
      }

      showSuccess(message) {
        this.showMessage(message, 'success');
      }

      showMessage(message, type) {
        const existingMessage = this.modal.querySelector('.form-message');
        if (existingMessage) {
          existingMessage.remove();
        }

        const messageEl = document.createElement('div');
        messageEl.className = `form-message form-message--${type}`;
        messageEl.textContent = message;

        const submitBtn = this.form.querySelector('.submit-button');
        submitBtn.parentNode.insertBefore(messageEl, submitBtn);

        setTimeout(() => {
          if (messageEl.parentNode) {
            messageEl.remove();
          }
        }, 5000);
      }
    }

    window.openContactModal = function () {
      if (!modalInstance) {
        modalInstance = new ContactModal();
      }
      modalInstance.open();
    };

    function initModal() {
      if (!modalInstance && document.getElementById('contactModal')) {
        modalInstance = new ContactModal();
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initModal);
    } else {
      initModal();
    }
  })();
</script>