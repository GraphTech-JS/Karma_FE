<script>
  document.addEventListener("DOMContentLoaded", function () {
      const i18n = {
          searchResults: "{{ i18n "guides.search.results" }}",
          noResults: "{{ i18n "guides.search.noResults" }}",
          onThisPage: "{{ i18n "guides.search.onThisPage" }}",
          searching: "{{ i18n "guides.search.searching" }}"
      };

      const searchInputs = document.querySelectorAll('#desktop-search-input, #tablet-search-input, #knowledge-search');
      const searchButtons = document.querySelectorAll('#desktop-search-button, #tablet-search-button, #knowledge-search-button');

      let searchResults = document.getElementById('search-results');
      let searchResultsList = document.getElementById('search-results-list');

      if (!searchResults) {
          const searchContainer = document.getElementById('search-results-container') ||
              document.getElementById('search-message-container');

          if (searchContainer) {
              const resultsDiv = document.createElement('div');
              resultsDiv.id = 'search-results';
              resultsDiv.className = 'hidden mb-6';

              const titleH3 = document.createElement('h3');
              titleH3.id = 'search-results-title';
              titleH3.className = 'font-[Montserrat] text-xl text-left font-semibold mb-4 text-[#ba0108]';

              const listDiv = document.createElement('div');
              listDiv.id = 'search-results-list';
              listDiv.className = 'space-y-4';

              resultsDiv.appendChild(titleH3);
              resultsDiv.appendChild(listDiv);
              searchContainer.appendChild(resultsDiv);

              searchResults = resultsDiv;
              searchResultsList = listDiv;
          }
      }

      let guidesIndex = [];
      let contentCache = {};

      function buildGuidesIndex() {
          guidesIndex = [];

          const categoryNav = document.getElementById('left-category-nav');

          if (categoryNav) {
              const categories = categoryNav.querySelectorAll('details.asideDetails');

              categories.forEach(category => {
                  const categoryName = category.querySelector('summary span')?.textContent.trim() || '';
                  const links = category.querySelectorAll('ul a[href]');
                  links.forEach(link => {
                      const title = link.textContent.trim();
                      const url = link.getAttribute('href');
                      if (title && url && url.includes('/guides/')) {
                          guidesIndex.push({ title: title, url: url, category: categoryName });
                      }
                  });
              });
          }

          if (guidesIndex.length === 0) {
              const knowledgeSections = document.querySelectorAll('.knowledge-section');

              knowledgeSections.forEach((section) => {
                  const categoryName = section.querySelector('h2')?.textContent.trim() || '';
                  const items = section.querySelectorAll('.knowledge-item a[href]');

                  items.forEach(link => {
                      const title = link.querySelector('h3')?.textContent.trim();
                      const url = link.getAttribute('href');

                      if (title && url && url.includes('/guides/')) {
                          guidesIndex.push({ title: title, url: url, category: categoryName });
                      }
                  });
              });
          }
      }

      async function fetchArticleContent(url) {
          try {
              const u = new URL(url, window.location.origin);
              u.hash = '';
              u.search = '';
              const urlWithSlash = u.pathname.endsWith('/') ? u.pathname : (u.pathname + '/');
              const cacheKey = urlWithSlash;

              if (contentCache[cacheKey]) {
                  return contentCache[cacheKey];
              }

              const fetchHtml = async (path) => {
                  const res = await fetch(path, { cache: 'no-store', headers: { 'Cache-Control': 'no-cache' } });
                  if (!res.ok) throw new Error(`HTTP ${res.status}`);
                  return await res.text();
              };

              let html = null;
              try {
                  html = await fetchHtml(urlWithSlash);
              } catch (_) {
                  try {
                      const urlNoSlash = u.pathname.endsWith('/') ? u.pathname.slice(0, -1) : u.pathname;
                      html = await fetchHtml(urlNoSlash);
                  } catch (e2) {
                      html = await fetchHtml(url);
                  }
              }

              if (!html) return null;

              const parser = new DOMParser();
              const doc = parser.parseFromString(html, 'text/html');
              const articleContent = doc.getElementById('article-content') || doc.querySelector('.markdown-content');
              if (!articleContent) return null;

              articleContent.querySelectorAll('script, style, noscript').forEach(el => el.remove());

              let content = articleContent.textContent || articleContent.innerText || '';
              content = content
                  .replace(/[\u2018\u2019]/g, "'")
                  .replace(/[\u201C\u201D]/g, '"')
                  .replace(/[\u2013\u2014]/g, '-')
                  .replace(/\u00A0/g, ' ')
                  .replace(/\s+/g, ' ')
                  .trim();

              contentCache[cacheKey] = content;
              return content;
          } catch (error) {
              return null;
          }
      }

      function findContextInText(text, query, isLongQuery) {
          const normalizedText = text.includes('\n') ? text.replace(/\s+/g, ' ') : text;

          let normalizedQuery = query
              .replace(/[\u2018\u2019]/g, "'")
              .replace(/[\u201C\u201D]/g, '"')
              .replace(/[\u2013\u2014]/g, '-')
              .replace(/\u00A0/g, ' ')
              .replace(/\s+/g, ' ')
              .trim();

          let searchPattern = normalizedQuery.replace(/[-\/\\^$*+?()|\[\]{}]/g, '\\$&');
          searchPattern = searchPattern.replace(/[\.,:;!?]/g, '[.,;:!?]?');
          if (isLongQuery) {
              searchPattern = searchPattern.replace(/\s+/g, '\\s+');
          }

          const regex = new RegExp(searchPattern, 'gi');
          const match = regex.exec(normalizedText);

          if (match) {
              const matchLength = match[0].length;
              const contextPadding = isLongQuery ? 80 : 50;
              const start = Math.max(0, match.index - contextPadding);
              const end = Math.min(normalizedText.length, match.index + matchLength + contextPadding);
              let context = (start > 0 ? '...' : '') +
                  normalizedText.substring(start, end).trim() +
                  (end < normalizedText.length ? '...' : '');

              const maxContextLength = isLongQuery ? 350 : 200;
              if (matchLength < 100 && context.length > maxContextLength) {
                  context = context.substring(0, maxContextLength) + '...';
              }

              return {
                  context: context,
                  matchedText: match[0]
              };
          }

          return null;
      }

      function clearSearch() {
          if (searchResultsList) {
              searchResultsList.innerHTML = '';
          }

          const titleElement = document.getElementById('search-results-title');
          if (titleElement) {
              titleElement.textContent = '';
          }

          document.querySelectorAll('span.search-highlight-yellow').forEach(span => {
              const parent = span.parentNode;
              if (parent) {
                  parent.replaceChild(document.createTextNode(span.textContent), span);
                  parent.normalize();
              }
          });
      }

      function highlightTextInPage(query) {
          const articleContent = document.getElementById('article-content') || document.querySelector('.markdown-content');

          if (!articleContent) {
              return;
          }

          let normalizedQuery = query
              .replace(/[\u2018\u2019]/g, "'")
              .replace(/[\u201C\u201D]/g, '"')
              .replace(/[\u2013\u2014]/g, '-')
              .replace(/\u00A0/g, ' ')
              .replace(/\s+/g, ' ')
              .trim();

          const wordCount = normalizedQuery.split(/\s+/).length;
          const isLongQuery = normalizedQuery.length > 15 || wordCount >= 3;

          let searchPattern = normalizedQuery.replace(/[-\/\\^$*+?()|\[\]{}]/g, '\\$&');
          searchPattern = searchPattern.replace(/[\.,:;!?]/g, '[.,;:!?]?');

          if (isLongQuery) {
              searchPattern = searchPattern.replace(/\s+/g, '\\s+');
          }
          const regex = new RegExp(`(${searchPattern})`, 'gi');

          const searchContainer = articleContent.parentElement;

          const walker = document.createTreeWalker(
              searchContainer,
              NodeFilter.SHOW_TEXT,
              {
                  acceptNode: node => {
                      if (node.parentNode.closest('script, style, #search-results')) {
                          return NodeFilter.FILTER_REJECT;
                      }
                      if (!node.textContent.trim()) {
                          return NodeFilter.FILTER_REJECT;
                      }

                      const normalizedNodeText = node.textContent
                          .replace(/[\u2018\u2019]/g, "'")
                          .replace(/[\u201C\u201D]/g, '"')
                          .replace(/[\u2013\u2014]/g, '-')
                          .replace(/\u00A0/g, ' ')
                          .replace(/\s+/g, ' ');

                      if (!regex.test(normalizedNodeText)) {
                          return NodeFilter.FILTER_REJECT;
                      }
                      return NodeFilter.FILTER_ACCEPT;
                  }
              }
          );

          const nodesToProcess = [];
          while (walker.nextNode()) {
              nodesToProcess.push(walker.currentNode);
          }

          nodesToProcess.forEach((textNode) => {
              const originalText = textNode.textContent;
              const normalizedText = originalText
                  .replace(/[\u2018\u2019]/g, "'")
                  .replace(/[\u201C\u201D]/g, '"')
                  .replace(/[\u2013\u2014]/g, '-')
                  .replace(/\u00A0/g, ' ')
                  .replace(/\s+/g, ' ');

              const fragment = document.createDocumentFragment();
              let lastIndex = 0;

              normalizedText.replace(regex, (match, ...args) => {
                  const offset = args[args.length - 2];

                  if (offset > lastIndex) {
                      fragment.appendChild(document.createTextNode(originalText.substring(lastIndex, offset)));
                  }

                  const highlightSpan = document.createElement('span');
                  highlightSpan.textContent = originalText.substring(offset, offset + match.length);
                  highlightSpan.className = 'search-highlight-yellow';
                  fragment.appendChild(highlightSpan);

                  lastIndex = offset + match.length;
              });

              if (lastIndex < normalizedText.length) {
                  fragment.appendChild(document.createTextNode(originalText.substring(lastIndex, normalizedText.length)));
              }

              if (fragment.childNodes.length > 0) {
                  const parent = textNode.parentNode;
                  if (parent) {
                      parent.replaceChild(fragment, textNode);
                  }
              }
          });
      }

      async function executeSearch() {
          clearSearch();

          let query = '';
          searchInputs.forEach(input => {
              if (input && input.value.trim()) {
                  query = input.value.trim();
              }
          });

          if (query.length < 2) {
              searchResults.classList.add('hidden');
              return;
          }

          highlightTextInPage(query);

          if (guidesIndex.length === 0) {
              buildGuidesIndex();
          }

          const wordCount = query.trim().split(/\s+/).length;
          const isLongQuery = query.length > 15 || wordCount >= 3;

          const results = [];

          const articleContent = document.getElementById('article-content');
          const isKnowledgeBase = window.location.pathname.includes('/knowledge-base');
          const currentTitle = document.querySelector('h1')?.textContent.trim();
          const currentUrl = window.location.pathname;
          const currentArticle = guidesIndex.find(item => item.url === currentUrl);
          const currentCategory = currentArticle ? currentArticle.category : '';

          if (articleContent && !isKnowledgeBase) {
              const contextMatches = [];
              let searchPattern = query.replace(/[-\/\\^$*+?()|\[\]{}]/g, '\\$&');
              searchPattern = searchPattern.replace(/[\.,:;!?]/g, '[.,;:!?]?');
              if (isLongQuery) {
                  searchPattern = searchPattern.replace(/\s+/g, '\\s+');
              }
              const exactRegex = new RegExp(searchPattern, 'gi');

              const titleMatch = currentTitle && exactRegex.test(currentTitle);

              if (titleMatch) {
                  contextMatches.push({
                      context: currentTitle,
                      position: 0,
                      matchedText: currentTitle,
                      isExact: true,
                      isTitle: true
                  });
              }

              exactRegex.lastIndex = 0;
              const articleText = articleContent.textContent;
              let match;

              while ((match = exactRegex.exec(articleText)) !== null && contextMatches.length < 3) {
                  const matchLength = match[0].length;
                  const contextPadding = 30;
                  const start = Math.max(0, match.index - contextPadding);
                  const end = Math.min(articleText.length, match.index + matchLength + contextPadding);
                  let context = (start > 0 ? '...' : '') +
                      articleText.substring(start, end).trim() +
                      (end < articleText.length ? '...' : '');

                  if (matchLength < 100 && context.length > 200) {
                      context = context.substring(0, 200) + '...';
                  }

                  contextMatches.push({
                      context: context,
                      position: match.index,
                      matchedText: match[0],
                      isExact: true
                  });
              }

              if (contextMatches.length > 0) {
                  results.push({
                      title: currentTitle || 'Поточна стаття',
                      url: currentUrl,
                      category: currentCategory,
                      matches: contextMatches,
                      matchCount: contextMatches.length,
                      isCurrent: true
                  });
              }
          }

          const articlesToSearch = guidesIndex.filter(item => item.url !== currentUrl);

          if (articlesToSearch.length > 0) {
              searchResults.classList.remove('hidden');
              searchResultsList.innerHTML = '<div class="p-4 text-center text-gray-600"><div class="flex gap-2 justify-center items-center"><svg class="animate-spin h-5 w-5 text-[#ba0108]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>' + i18n.searching + '</span></div></div>';
          }

          const contentSearchResults = await Promise.all(
              articlesToSearch.map(async (item) => {
                  let searchPattern = query.replace(/[-\/\\^$*+?()|\[\]{}]/g, '\\$&');
                  searchPattern = searchPattern.replace(/[\.,:;!?]/g, '[.,;:!?]?');
                  if (isLongQuery) {
                      searchPattern = searchPattern.replace(/\s+/g, '\\s+');
                  }
                  const titleRegex = new RegExp(searchPattern, 'gi');

                  const titleMatch = titleRegex.test(item.title);
                  if (titleMatch) {
                      return {
                          ...item,
                          matches: [{
                              context: item.title,
                              matchedText: item.title,
                              isExact: true,
                              isTitle: true
                          }],
                          matchCount: 1,
                          hasContentMatch: true
                      };
                  }

                  const content = await fetchArticleContent(item.url);

                  if (content) {
                      const contextResult = findContextInText(content, query, isLongQuery);

                      if (contextResult) {
                          return {
                              ...item,
                              matches: [{
                                  context: contextResult.context,
                                  matchedText: contextResult.matchedText,
                                  isExact: true
                              }],
                              matchCount: 1,
                              hasContentMatch: true
                          };
                      }
                  }

                  return null;
              })
          );

          const filteredResults = contentSearchResults.filter(r => r !== null && r.hasContentMatch);
          results.push(...filteredResults.slice(0, 5));

          displayResults(results, query);
      }

      function displayResults(results, query) {
          if (!searchResultsList) {
              return;
          }

          searchResultsList.innerHTML = '';
          const titleElement = document.getElementById('search-results-title');

          if (results.length > 0) {
              searchResults.classList.remove('hidden');

              const MAX_TOTAL = 6;
              const finalResults = [];

              const currentRes = results.find(r => r.isCurrent && r.matches && r.matches.length > 0);
              if (currentRes) {
                  finalResults.push({
                      ...currentRes,
                      matches: [currentRes.matches[0]]
                  });
              }

              for (const r of results) {
                  if (finalResults.length >= MAX_TOTAL) break;
                  if (r.isCurrent) continue;
                  if (r.hasContentMatch && r.matches && r.matches.length > 0) {
                      finalResults.push({
                          ...r,
                          matches: [r.matches[0]]
                      });
                  }
              }

              if (titleElement) {
                  titleElement.textContent = i18n.searchResults + ' (' + finalResults.length + ')';
              }

              finalResults.forEach(result => {
                  if (result.isCurrent && result.matches && result.matches.length > 0) {
                      result.matches.forEach(matchItem => {
                          const resultElement = document.createElement('div');
                          resultElement.className = 'block p-3 text-gray-800 bg-gray-50 hover:bg-gray-100 rounded-md my-1 text-sm border-l-4 border-[#ba0108]';
                          resultElement.style.cursor = 'pointer';

                          let highlightedContext = matchItem.context;
                          const wordCount = query.trim().split(/\s+/).length;
                          const isLongQuery = query.length > 15 || wordCount >= 3;

                          if (isLongQuery) {
                              const queryRegex = new RegExp(`(${query.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'gi');
                              highlightedContext = highlightedContext.replace(
                                  queryRegex,
                                  '<span class="text-[#ba0108] font-semibold">$1</span>'
                              );
                          } else {
                              const queryWordsForHighlight = query.split(/\s+/).filter(w => w.length >= 2);
                              queryWordsForHighlight.forEach(word => {
                                  const wordRegex = new RegExp(`(${word.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'gi');
                                  highlightedContext = highlightedContext.replace(
                                      wordRegex,
                                      '<span class="text-[#ba0108] font-semibold">$1</span>'
                                  );
                              });
                          }

                          resultElement.innerHTML = `
              <div class="flex gap-2 items-start">
                <img src="/img/point.svg" alt="" class="flex-shrink-0 mt-0.5 w-4 h-4" />
                <div class="flex-1">
                  <h3 class="font-[Montserrat] font-semibold text-sm mb-2 text-[#ba0108]">${result.title}</h3>
                  <div class="mb-1 text-xs text-gray-500">
                    <span class="inline-block px-2 py-0.5 mr-2 text-xs text-blue-800 bg-blue-100 rounded">` + i18n.onThisPage + `</span>
                    ${result.category}
                  </div>
                  <p class="text-sm">${highlightedContext}</p>
                </div>
              </div>
            `;

                          resultElement.addEventListener('click', () => {
                              searchResults.classList.add('hidden');

                              setTimeout(() => {
                                  const firstHighlight = document.querySelector('.search-highlight-yellow');

                                  if (firstHighlight) {
                                      let parentBlock = firstHighlight.parentElement;

                                      while (parentBlock && ['STRONG', 'EM', 'SPAN', 'A', 'CODE', 'B', 'I', 'U'].includes(parentBlock.tagName)) {
                                          parentBlock = parentBlock.parentElement;
                                      }

                                      if (!parentBlock || !['P', 'LI', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6', 'TD', 'TH', 'DIV'].includes(parentBlock.tagName)) {
                                          parentBlock = firstHighlight.closest('p, li, h1, h2, h3, h4, h5, h6, td, th, div');
                                      }

                                      if (parentBlock) {
                                          const yOffset = -100;
                                          const y = parentBlock.getBoundingClientRect().top + window.pageYOffset + yOffset;

                                          window.scrollTo({
                                              top: y,
                                              behavior: 'smooth'
                                          });

                                          parentBlock.style.backgroundColor = 'rgba(186, 1, 8, 0.1)';
                                          parentBlock.style.transition = 'background-color 0.3s';

                                          setTimeout(() => {
                                              parentBlock.style.backgroundColor = '';
                                          }, 3000);
                                      } else {
                                          const yOffset = -100;
                                          const y = firstHighlight.getBoundingClientRect().top + window.pageYOffset + yOffset;

                                          window.scrollTo({
                                              top: y,
                                              behavior: 'smooth'
                                          });
                                      }
                                  }
                              }, 200);
                          });

                          searchResultsList.appendChild(resultElement);
                      });
                  } else if (result.hasContentMatch && result.matches && result.matches.length > 0) {
                      result.matches.forEach(matchItem => {
                          const resultElement = document.createElement('a');

                          let searchQuery = '';
                          searchInputs.forEach(input => {
                              if (input && input.value.trim()) {
                                  searchQuery = input.value.trim();
                              }
                          });

                          resultElement.href = result.url + '?highlight=' + encodeURIComponent(searchQuery);
                          resultElement.className = 'block p-3 text-gray-800 bg-gray-50 hover:bg-gray-100 rounded-md my-1 text-sm border-l-4 border-[#ba0108] transition-colors';
                          resultElement.style.cursor = 'pointer';

                          let highlightedContext = matchItem.context;
                          const wordCount = query.trim().split(/\s+/).length;
                          const isLongQuery = query.length > 15 || wordCount >= 3;

                          if (isLongQuery) {
                              const queryRegex = new RegExp(`(${query.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'gi');
                              highlightedContext = highlightedContext.replace(
                                  queryRegex,
                                  '<span class="text-[#ba0108] font-semibold">$1</span>'
                              );
                          } else {
                              const queryWordsForHighlight = query.split(/\s+/).filter(w => w.length >= 2);
                              queryWordsForHighlight.forEach(word => {
                                  const wordRegex = new RegExp(`(${word.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'gi');
                                  highlightedContext = highlightedContext.replace(
                                      wordRegex,
                                      '<span class="text-[#ba0108] font-semibold">$1</span>'
                                  );
                              });
                          }

                          resultElement.innerHTML = `
              <div class="flex gap-2 items-start">
                <img src="/img/point.svg" alt="" class="flex-shrink-0 mt-0.5 w-4 h-4" />
                <div class="flex-1">
                  <h3 class="font-[Montserrat] font-semibold text-sm mb-2 text-[#ba0108]">${result.title}</h3>
                  <div class="mb-1 text-xs text-gray-500">${result.category}</div>
                  <p class="text-sm">${highlightedContext}</p>
                </div>
              </div>
            `;

                          searchResultsList.appendChild(resultElement);
                      });
                  }
              });
          } else {
              searchResults.classList.remove('hidden');

              if (titleElement) {
                  titleElement.textContent = i18n.searchResults;
              }

              const noResultsElement = document.createElement('div');
              noResultsElement.className = 'p-4 text-gray-600 text-center';
              noResultsElement.textContent = i18n.noResults;
              searchResultsList.appendChild(noResultsElement);
          }
      }

      function syncSearchInputs() {
          searchInputs.forEach(sourceInput => {
              if (sourceInput) {
                  sourceInput.addEventListener('input', (event) => {
                      const value = event.target.value;
                      searchInputs.forEach(targetInput => {
                          if (targetInput && targetInput !== sourceInput) {
                              targetInput.value = value;
                          }
                      });
                      if (value.length === 0) {
                          clearSearch();
                          searchResults.classList.add('hidden');
                      }
                  });
              }
          });
      }

      syncSearchInputs();

      searchButtons.forEach((button, index) => {
          if (button) {
              button.addEventListener('click', executeSearch);
          }
      });

      searchInputs.forEach(input => {
          if (input) {
              input.addEventListener('keydown', (event) => {
                  if (event.key === 'Enter') {
                      event.preventDefault();
                      executeSearch();
                  }
              });
          }
      });

      buildGuidesIndex();

      const urlParams = new URLSearchParams(window.location.search);
      const highlightQuery = urlParams.get('highlight');

      if (highlightQuery) {
          const attemptHighlight = (attemptNumber = 1, maxAttempts = 8) => {
              const articleContent = document.getElementById('article-content');
              if (!articleContent) {
                  if (attemptNumber < maxAttempts) {
                      setTimeout(() => attemptHighlight(attemptNumber + 1, maxAttempts), 500);
                  }
                  return;
              }

              highlightTextInPage(decodeURIComponent(highlightQuery));

              setTimeout(() => {
                  const highlights = document.querySelectorAll('.search-highlight-yellow');

                  if (highlights.length > 0) {
                      const firstHighlight = highlights[0];
                      let parentBlock = firstHighlight.parentElement;

                      while (parentBlock && ['STRONG', 'EM', 'SPAN', 'A', 'CODE', 'B', 'I', 'U'].includes(parentBlock.tagName)) {
                          parentBlock = parentBlock.parentElement;
                      }

                      if (!parentBlock || !['P', 'LI', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6', 'TD', 'TH', 'DIV'].includes(parentBlock.tagName)) {
                          parentBlock = firstHighlight.closest('p, li, h1, h2, h3, h4, h5, h6, td, th, div');
                      }

                      if (parentBlock) {
                          try {
                              parentBlock.scrollIntoView({ behavior: 'smooth', block: 'center' });

                              setTimeout(() => {
                                  const rect = parentBlock.getBoundingClientRect();
                                  const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                                  const elementTop = rect.top + scrollTop;
                                  const offset = elementTop - (window.innerHeight / 2) + (rect.height / 2);

                                  window.scrollTo({
                                      top: offset,
                                      behavior: 'smooth'
                                  });
                              }, 100);

                              parentBlock.style.backgroundColor = 'rgba(186, 1, 8, 0.1)';
                              parentBlock.style.transition = 'background-color 0.3s';

                              setTimeout(() => {
                                  parentBlock.style.backgroundColor = '';
                              }, 3000);
                          } catch (e) {
                          }
                      } else {
                          firstHighlight.scrollIntoView({ behavior: 'smooth', block: 'center' });
                      }

                      const url = new URL(window.location);
                      url.searchParams.delete('highlight');
                      window.history.replaceState({}, '', url);
                  } else if (attemptNumber < maxAttempts) {
                      setTimeout(() => attemptHighlight(attemptNumber + 1, maxAttempts), 400 * attemptNumber);
                  } else {
                      const url = new URL(window.location);
                      url.searchParams.delete('highlight');
                      window.history.replaceState({}, '', url);
                  }
              }, 300);
          };

          setTimeout(() => attemptHighlight(), 600);
      }
  });
</script>
