{{ $context := . }}
{{ if isset . "context" }}{{ $context = .context }}{{ end }}

{{ $products := where $context.Site.RegularPages "Section" "catalog" }}
{{ $categorySlug := path.Base (strings.TrimSuffix "/" $context.RelPermalink) }}

{{ $categoryMapping := dict
"politni-steky" (slice "politni-steky" "flight-stacks")
"videoperedavachi-vtx" (slice "videoperedavachi-vtx" "video-transmitters")
"esc" (slice "esc")
}}

{{ $categoryProducts := slice }}
{{ $category := "" }}

{{ if $context.IsHome }}
{{ $possibleCategories := index $categoryMapping "politni-steky" }}
{{ $categoryProducts = where $products "Params.category" "in" $possibleCategories }}
{{ $category = "politni-steky" }}
{{ else }}
{{ $possibleCategories := index $categoryMapping $categorySlug | default (slice $categorySlug) }}
{{ $categoryProducts = where $products "Params.category" "in" $possibleCategories }}
{{ $category = $categorySlug }}
{{ end }}

<section class="relative flex flex-col justify-center items-center gap-[20px] overflow-hidden">
  {{ if $context.IsHome }}
  <div
    class="absolute top-0 right-[-22px] max-[767px]:right-[-41px] max-[767px]:top-[calc(var(--spacing)*-32)] max-[450px]:right-[-15px] max-[450px]:top-[calc(var(--spacing)*-19)]">
    {{ $bgEl1 := resources.Get "img/bg-el-slider.png" }}
    {{ if $bgEl1 }}
    {{ $bgEl1Mobile := $bgEl1.Resize "200x200 webp q70" }}
    {{ $bgEl1Tablet := $bgEl1.Resize "313x287 webp q75" }}
    {{ $bgEl1Desktop := $bgEl1.Resize "455x417 webp q80" }}
    <picture>
      <source media="(max-width: 450px)" srcset="{{ $bgEl1Mobile.RelPermalink }}" type="image/webp">
      <source media="(max-width: 768px)" srcset="{{ $bgEl1Tablet.RelPermalink }}" type="image/webp">
      <source media="(min-width: 769px)" srcset="{{ $bgEl1Desktop.RelPermalink }}" type="image/webp">
      <img src="{{ $bgEl1Desktop.RelPermalink }}" alt="" aria-hidden="true" width="455" height="417"
        class="w-[455px] h-[417px] max-[1199px]:w-[313px] max-[1199px]:h-[287px] max-[1100px]:w-[350px] max-[1100px]:h-[330px] max-[900px]:w-[300px] max-[900px]:h-[280px] max-[768px]:w-[313px] max-[768px]:h-[387px] max-[450px]:w-[200px] max-[450px]:h-[200px] object-contain"
        loading="lazy" />
    </picture>
    {{ else }}
    <img src="/img/bg-el-slider.png" alt="" aria-hidden="true" width="455" height="417"
      class="w-[455px] h-[417px] max-[1199px]:w-[313px] max-[1199px]:h-[287px] max-[1100px]:w-[350px] max-[1100px]:h-[330px] max-[900px]:w-[300px] max-[900px]:h-[280px] max-[768px]:w-[313px] max-[768px]:h-[387px] max-[450px]:w-[200px] max-[450px]:h-[200px] object-contain"
      loading="lazy" />
    {{ end }}
  </div>
  {{ end }}

  <div class="flex flex-col w-full max-w-[1200px] products-slider mt-[60px] lg:mt-[80px] mb-[60px] lg:mb-[80px]">
    <h3 class="font-['Unbounded'] text-[clamp(24px,4vw,40px)] font-medium  mb-[40px] text-center hero-title">
      <span class="text-[#ba0108]">{{ i18n "products.title.brand" }}</span>{{ i18n "products.title" }}
    </h3>

    <!-- Desktop & Tablet Layout (768px+) -->
    <div class="hidden min-[768px]:block relative">
      <div class="swiper-container-products">
        <div class="swiper-wrapper">
          {{ range $categoryProducts }}
          <div class="swiper-slide">
            <div
              class="bg-[#fff] rounded-[10px] p-[20px] [box-shadow:0_4px_16px_rgba(0,_0,_0,_0.1)] w-full max-w-[400px] text-center mx-0 flex flex-col h-full">
              {{ $productImage := resources.Get .Params.image }} {{ if
              $productImage }}
              {{ $prodSmall := $productImage.Resize "300x webp q60" }}
              {{ $prodMed := $productImage.Resize "350x webp q60" }}
              {{ $prodLarge := $productImage.Resize "400x webp q60" }}

              <img src="{{ $prodMed.RelPermalink }}" srcset="{{ $prodSmall.RelPermalink }} 300w,
                      {{ $prodMed.RelPermalink }} 350w,
                      {{ $prodLarge.RelPermalink }} 400w" sizes="(max-width: 768px) 300px,
                     (max-width: 1024px) 350px,
                     400px" alt="{{ .Title }}" width="400" height="300" class="w-full h-[300px] object-contain"
                loading="lazy" />
              {{ else }}
              <img src="{{ .Params.image }}" alt="{{ .Title }}" width="400" height="300"
                class="w-full h-[300px] object-contain" loading="lazy" />
              {{ end }}
              <h4
                class="product-title font-['Montserrat'] text-[clamp(20px,2.5vw,24px)] uppercase font-bold mt-[15px] mx-[37px] mb-[20px] text-[#020303] leading-[1.2] text-center break-words">
                {{ .Title }}
              </h4>
              <div
                class="text-left space-y-[8px] mb-[36px] grid grid-cols-[auto_1fr] gap-x-[15px] max-[1000px]:gap-x-[14px] max-[940px]:gap-x-[13px] max-[768px]:gap-x-[12px] max-[480px]:gap-x-[8px] gap-y-[8px]">
                {{ range .Params.specs }}
                <span class="text-[16px] font-['Montserrat'] font-semibold text-[#000] whitespace-nowrap">
                  {{ .label }}
                </span>
                <span class="text-[16px] font-['Montserrat'] font-normal text-[#000] whitespace-nowrap overflow-hidden text-ellipsis 
                  {{ if ne $category " politni-steky" }}text-right{{ end }}">
                  {{ .value }}
                </span>
                {{ end }}
              </div>
              <a href="{{ .RelPermalink }}">
                <button
                  class="bg-[#ba0108] text-[#fff] border-[none]  px-[30px] py-[15px] mt-5 rounded-[20px] cursor-pointer text-[clamp(16px,2.2vw,20px)] font-['Montserrat'] font-normal [transition:background-color_0.3s_ease] hover:bg-[#e39599] w-full">
                  {{ i18n "products.button.more" }}
                </button>
              </a>
            </div>
          </div>
          {{ end }}
        </div>
      </div>

      <!-- Desktop & Tablet Navigation arrows -->
      <div
        class="swiper-button-prev-custom absolute top-[50%] transform -translate-y-1/2 z-10 cursor-pointer flex items-center justify-center transition-shadow">
        <img src="/img/nav_arrow.svg" alt="navigation prev arrow" class="rotate-180" loading="lazy" />
      </div>
      <div
        class="swiper-button-next-custom absolute top-[50%] transform -translate-y-1/2 z-10 cursor-pointer flex items-center justify-center transition-shadow">
        <img src="/img/nav_arrow.svg" alt="navigation next arrow" loading="lazy" />
      </div>
    </div>

    <!-- Mobile Layout (767px and below) -->
    <div class="block min-[768px]:hidden relative">
      <div class="flex flex-col gap-[15px] items-center">
        {{ range $categoryProducts }}
        <div class="w-full max-w-[350px]">
          <div
            class="bg-[#fff] rounded-[10px] p-[20px] [box-shadow:0_4px_16px_rgba(0,_0,_0,_0.1)] w-full text-center mx-auto">
            {{ $productImageMobile := resources.Get .Params.image }} {{ if
            $productImageMobile }} {{ $prodMobSmall := $productImageMobile.Resize "232x webp q70" }}
            {{ $prodMobMed := $productImageMobile.Resize "310x webp q60" }}
            {{ $prodMobLarge := $productImageMobile.Resize "350x webp q60" }}

            <img src="{{ $prodMobMed.RelPermalink }}" srcset="{{ $prodMobSmall.RelPermalink }} 232w,
                      {{ $prodMobMed.RelPermalink }} 310w,
                      {{ $prodMobLarge.RelPermalink }} 350w" sizes="(max-width: 480px) 232px,
                     (max-width: 768px) 310px,
                     350px" alt="{{ .Title }}" width="350" height="262"
              class="w-full h-[262px] object-contain mb-[15px]" loading="lazy" />
            {{ else }}
            <img src="{{ .Params.image }}" alt="{{ .Title }}" width="350" height="262"
              class="w-full h-[262px] object-contain mb-[15px]" loading="lazy" />
            {{ end }}
            <h4
              class="font-['Unbounded'] text-[20px] font-medium mt-[15px] mx-[0] mb-[20px] text-[#020303] leading-[1.2]">
              {{ .Title }}
            </h4>
            <div
              class="text-left space-y-[8px] mb-[36px] grid grid-cols-[auto_1fr] gap-x-[12px] max-[480px]:gap-x-[18px] gap-y-[8px]">
              {{ range .Params.specs }}
              <span class="text-[15px] font-['Montserrat'] font-semibold text-[#000] whitespace-nowrap">
                {{ .label }}
              </span>
              <span
                class="text-[14px] font-['Montserrat'] font-normal text-[#000] whitespace-nowrap {{ if ne $category "politni-steky" }}text-right{{ end }}">
                {{ .value }}
              </span>
              {{ end }}
            </div>
            <a class="pt-[36px]" href="{{ .RelPermalink }}">
              <button
                class="inline-block bg-[#ba0108] text-[#fff] border-[none]  px-[30px] py-[15px] mt-5 rounded-[20px] cursor-pointer text-[clamp(14px,1.8vw,16px)] font-['Montserrat'] font-normal [transition:background-color_0.3s_ease] hover:bg-[#e39599] w-full">
                {{ i18n "products.button.more" }}
              </button>
            </a>
          </div>
        </div>
        {{ end }}
      </div>
    </div>
  </div>
</section>

<script>
  function fixTitlePadding() {
    document.querySelectorAll('.product-title').forEach(title => {
      if (title.textContent.trim().length > 32) {
        title.classList.remove('mx-[37px]');
        title.classList.add('px-2');
      }
    });
  }

  function equalizeProductTitles() {
    const titles = document.querySelectorAll('.products-slider .product-title');
    if (!titles.length) return;

    requestAnimationFrame(() => {
      titles.forEach(t => t.style.minHeight = "0px");

      requestAnimationFrame(() => {
        const heights = Array.from(titles, t => t.getBoundingClientRect().height);
        const max = Math.max(...heights);

        requestAnimationFrame(() => {
          titles.forEach(t => t.style.minHeight = `${max}px`);
        });
      });
    });
  }

  function debounce(fn, wait) {
    let t;
    return () => {
      clearTimeout(t);
      t = setTimeout(fn, wait);
    };
  }

  fixTitlePadding();
  window.addEventListener("load", equalizeProductTitles);
  window.addEventListener("resize", debounce(equalizeProductTitles, 150));
</script>