{{ define "main" }}
<section class="relative z-10 bg-white">
  {{ $bgEl10 := resources.Get "img/bg-el-10.png" }}
  {{ if $bgEl10 }}
  {{ $bgEl10Desktop := $bgEl10.Resize "295x270 webp q80" }}
  <img fetchpriority="high" src="{{ $bgEl10Desktop.RelPermalink }}" alt="{{ i18n " kb.aria.bg" }}" aria-hidden="true"
    class="fixed hidden md:block z-[1] top-0 lg:top-[-2%] left-0 w-[191px] lg:w-[295px] h-auto" />
  {{ else }}
  <img fetchpriority="high" src="/img/bg-el-1.png" alt="{{ i18n " kb.aria.bg" }}" aria-hidden="true"
    class="fixed hidden md:block z-[1] top-0 lg:top-[-2%] left-0 w-[191px] lg:w-[295px] h-auto" />
  {{ end }}

  {{ $bgEl1 := resources.Get "img/bg-el-1.png" }}
  {{ if $bgEl1 }}
  {{ $bgEl1Processed := $bgEl1.Resize "201x webp q80" }}
  <img fetchpriority="high" src="{{ $bgEl1Processed.RelPermalink }}" alt="{{ i18n " kb.aria.bg" }}" aria-hidden="true"
    class="fixed block md:hidden z-[1] right-[-20%] top-0 w-[201px] h-auto opacity-50" />
  {{ else }}
  <img fetchpriority="high" src="/img/bg-el-1.png" alt="{{ i18n " kb.aria.bg" }}" aria-hidden="true"
    class="fixed block md:hidden z-[1] right-[-20%] top-0 w-[201px] h-auto opacity-50" />
  {{ end }}

  <div class="py-[36px] md:py-8 pb-[60px] w-full">
    <div
      class="flex flex-col gap-4 mb-[25px] md:mb-[35px] lg:mb-[50px] lg:flex-row lg:items-center lg:justify-between max-w-[1280px] mx-auto px-[20px]">
      <div class="flex items-center justify-start font-[Montserrat]">
        <a class="text-[16px] lg:text-[20px] font-normal text-[#ba0108]" href="{{ " /" | relLangURL }}">{{ i18n
          "catalog.hero.breadcrumb.home" }}</a>
        <span class="text-[#ba0108] px-[5px]">→</span>
        <span class="text-[16px] lg:text-[20px] font-normal text-[#ba0108]">{{ i18n "nav.knowledge" }}</span>
      </div>

      <!-- Search for all devices -->
      <div class="flex justify-center items-center max-w-[clamp(250px,90vw,400px)] lg:max-w-md">
        <div class="flex relative">
          <input type="text" placeholder='{{i18n "kb.search.placeholder"}}'
            class="h-[41px] lg:h-[47px] max-[390px]:w-[250px] w-full !rounded-[20px] font-[Montserrat] border border-black pl-[clamp(12px,2vw,16px)] pr-[clamp(80px,15vw,120px)] text-[clamp(14px,2vw,20px)] outline-none focus:border-[#ba0108] bg-white"
            id="knowledge-search" />
          <button
            class="absolute z-10 right-0 top-1/2 -translate-y-1/2 w-[clamp(70px,12vw,99px)] h-[41px] lg:h-[47px] rounded-[20px] bg-[#ba0108] flex items-center justify-center cursor-pointer hover:bg-[#a00007] transition-colors"
            aria-label="{{ i18n "kb.search.button.aria" }}">
            <img src="/img/search-icon.svg" alt="{{ i18n "kb.search.icon.alt" }}" width="30" height="30"
              class="filter brightness-0 invert" />
          </button>
        </div>
      </div>
    </div>

    <div id="search-message-container" class="max-w-[1280px] mx-auto px-[20px]"></div>

    <div class="relative z-20 space-y-0 w-full max-w-[1600px] mx-auto">
      {{- $currentLang := .Site.Language.Lang -}}
      {{- $allCats := slice -}}
      {{- range site.Sites -}}
      {{- $allCats = $allCats | append (where .RegularPages "Section" "categories") -}}
      {{- end -}}
      {{- $byBase := dict -}}
      {{- range $allCats -}}
      {{- $base := .File.TranslationBaseName -}}
      {{- $existing := index $byBase $base -}}
      {{- if not $existing -}}
      {{- $byBase = merge $byBase (dict $base .) -}}
      {{- else if eq .Lang $currentLang -}}
      {{- $byBase = merge $byBase (dict $base .) -}}
      {{- end -}}
      {{- end -}}
      {{- $categories := slice -}}
      {{- range $k, $v := $byBase -}}
      {{- $categories = $categories | append $v -}}
      {{- end -}}
      {{- $categories = sort $categories "Params.weight" "asc" "Title" "asc" -}}

      {{- $allGuides := slice -}}
      {{- range site.Sites -}}
      {{- $allGuides = $allGuides | append (where .RegularPages "Section" "guides") -}}
      {{- end -}}
      {{- $byGuideBase := dict -}}
      {{- range $allGuides -}}
      {{- $gbase := .File.TranslationBaseName -}}
      {{- $gexisting := index $byGuideBase $gbase -}}
      {{- if not $gexisting -}}
      {{- $byGuideBase = merge $byGuideBase (dict $gbase .) -}}
      {{- else if eq .Lang $currentLang -}}
      {{- $byGuideBase = merge $byGuideBase (dict $gbase .) -}}
      {{- end -}}
      {{- end -}}
      {{- $guides := slice -}}
      {{- range $k, $v := $byGuideBase -}}
      {{- $guides = $guides | append $v -}}
      {{- end -}}

      {{ range $index, $cat := $categories }}
      {{- $categorySlug := $cat.File.TranslationBaseName -}}
      {{- $categoryTitle := $cat.Title -}}

      {{- $bySlug := where $guides ".Params.category" $categorySlug -}}
      {{- $byTitle := where $guides ".Params.category" $categoryTitle -}}
      {{- $byCategorySlug := where $guides ".Params.category" $cat.Params.slug -}}

      {{- $searchTerms := slice $categoryTitle $categorySlug -}}
      {{- if $cat.Params.slug -}}
      {{- $searchTerms = $searchTerms | append $cat.Params.slug -}}
      {{- end -}}
      {{- if $cat.Params.aliases -}}
      {{- range $cat.Params.aliases -}}
      {{- $alias := . -}}
      {{- $searchTerms = $searchTerms | append $alias -}}
      {{- if not (hasPrefix $alias "-") -}}
      {{- $searchTerms = $searchTerms | append (printf "-%s" $alias) -}}
      {{- end -}}
      {{- end -}}
      {{- end -}}
      {{- $byAliases := where $guides ".Params.category" "in" $searchTerms -}}

      {{- $categoryGuides := union $bySlug (union $byTitle (union $byCategorySlug $byAliases)) -}}

      <details {{ if eq $index 0 }}open{{ end }} class="overflow-hidden knowledge-section group">
        <summary
          class="section-header bg-[#4a4a4a] text-white rounded-none cursor-pointer list-none outline-none select-none">
          <div
            class="flex justify-between items-center w-full h-[67px] md:h-[71px] lg:h-[86px] max-w-[1280px] px-[20px] mx-auto">
            <h2 class="text-[clamp(24px,3vw,40px)] font-bold font-['Unbounded'] tracking-wide">{{ $cat.Title }}</h2>
            <svg class="accordion-arrow w-[45px] h-auto transition-transform duration-300 transform" fill="none"
              stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
          </div>
        </summary>

        <div class="bg-white section-content">
          <div class="section-content-inner">
            {{ if $categoryGuides }}
            {{ range $categoryGuides }}
            <div class="knowledge-item mx-auto max-w-[1280px] px-0 lg:px-[20px] pr-[20px]">
              <a href="{{ .RelPermalink }}" class="block py-4 transition-colors lg:px-8 lg:py-6 hover:bg-gray-50">
                <div class="flex flex-1 gap-[11px] md:gap-[15px] items-start space-x-4">
                  <img src="/img/point.svg" alt="•" class="py-[5px] md:py-[10px]" />
                  <div class="flex-1">
                    <h3 class="text-[16px] md:text-[24px] font-semibold font-['Montserrat'] mb-[10px]">{{ .Title }}</h3>
                    {{ if .Params.description }}
                    <p class="text-[16px] leading-relaxed font-['Montserrat']">
                      {{ .Params.description }} <span class="text-[#ba0108]">&gt;&gt;</span>
                    </p>
                    {{ end }}
                  </div>
                </div>
              </a>
            </div>
            {{ end }}
            {{ else }}
            <div class="px-6 py-8 text-center text-gray-500 lg:px-8 lg:py-12">
              <p class="text-[clamp(16px,2vw,20px)] font-['Montserrat']">{{i18n "kb.content.soon"}}</p>
            </div>
            {{ end }}
          </div>
        </div>
      </details>
      {{ end }}
    </div>
  </div>
</section>

<style>
  .knowledge-section summary {
    list-style: none;
  }

  .knowledge-section summary::-webkit-details-marker {
    display: none;
  }

  .knowledge-section.is-open>.section-header {
    background-color: #ba0108 !important;
  }

  .section-content {
    overflow: hidden;
    transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .section-content-inner {
    border-left: 1px solid #e5e7eb;
    border-right: 1px solid #e5e7eb;
    border-bottom: 1px solid #e5e7eb;
  }

  .knowledge-item:hover h3 {
    color: #ba0108;
  }

  .knowledge-item.hidden {
    display: none;
  }

  .knowledge-item.highlighted {
    background-color: #fef2f2;
  }
</style>

<script>
  window.I18NKB = {
    "notFoundTpl": "{{i18n "kb.search.notFound.tpl" | plainify}}"
  };
</script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const allSections = document.querySelectorAll('.knowledge-section');
    const searchInput = document.getElementById('knowledge-search');
    const searchButton = searchInput?.nextElementSibling;

    function initAnimatedAccordion() {
      allSections.forEach(section => {
        const summary = section.querySelector('summary');
        const content = section.querySelector('.section-content');
        const arrow = summary.querySelector('.accordion-arrow');

        if (section.hasAttribute('open')) {
          section.classList.add('is-open'); arrow.classList.add('rotate-90');
          content.style.maxHeight = content.scrollHeight + 'px';
        } else {
          content.style.maxHeight = '0px'; section.classList.remove('is-open'); arrow.classList.remove('rotate-90');
        }

        let isAnimating = false;
        summary.addEventListener('click', e => {
          e.preventDefault();
          if (isAnimating) return;
          isAnimating = true;

          if (section.classList.contains('is-open')) {
            arrow.classList.remove('rotate-90');
            section.classList.remove('is-open');
            content.style.maxHeight = content.scrollHeight + 'px';
            requestAnimationFrame(() => { content.style.maxHeight = '0px'; });
            setTimeout(() => { section.removeAttribute('open'); isAnimating = false; }, 400);
          } else {
            arrow.classList.add('rotate-90');
            section.setAttribute('open', '');
            section.classList.add('is-open');
            content.style.maxHeight = content.scrollHeight + 'px';
            setTimeout(() => { if (section.classList.contains('is-open')) content.style.maxHeight = 'none'; isAnimating = false; }, 400);
          }
        });
      });
    }

    function showSearchMessage(message) {
      const container = document.getElementById('search-message-container');
      if (container) container.innerHTML = `<div class="text-center pb-[20px] text-gray-500 font-[Montserrat]">${message}</div>`;
    }
    function hideSearchMessage() {
      const container = document.getElementById('search-message-container');
      if (container) container.innerHTML = '';
    }

    function searchInContent(query) {
      if (!query) { resetSearch(); return; }
      let isAnyResultFound = false;
      allSections.forEach(section => {
        const items = section.querySelectorAll('.knowledge-item');
        let sectionHasMatch = false;
        items.forEach(item => {
          const title = item.querySelector('h3')?.textContent.toLowerCase() || '';
          const description = item.querySelector('p')?.textContent.toLowerCase() || '';
          if (title.includes(query) || description.includes(query)) {
            item.classList.remove('hidden');
            item.classList.add('highlighted');
            sectionHasMatch = true; isAnyResultFound = true;
          } else {
            item.classList.add('hidden');
            item.classList.remove('highlighted');
          }
        });

        const content = section.querySelector('.section-content');
        const arrow = section.querySelector('.accordion-arrow');
        if (sectionHasMatch) {
          section.setAttribute('open', ''); section.classList.add('is-open'); arrow.classList.add('rotate-90');
          content.style.maxHeight = 'none';
        } else {
          section.removeAttribute('open'); section.classList.remove('is-open'); arrow.classList.remove('rotate-90');
          content.style.maxHeight = '0px';
        }
      });

      if (!isAnyResultFound) {
        const t = window.I18NKB || {};
        const tpl = t.notFoundTpl || 'Нічого не знайдено за запитом: {query}';
        showSearchMessage(tpl.replace('{query}', query));
      } else {
        hideSearchMessage();
      }
    }

    function resetSearch() {
      allSections.forEach((section, index) => {
        section.querySelectorAll('.knowledge-item').forEach(item => item.classList.remove('hidden', 'highlighted'));
        const content = section.querySelector('.section-content');
        const arrow = section.querySelector('.accordion-arrow');
        if (index === 0) {
          section.setAttribute('open', ''); section.classList.add('is-open'); arrow.classList.add('rotate-90');
          content.style.maxHeight = 'none';
        } else {
          section.removeAttribute('open'); section.classList.remove('is-open'); arrow.classList.remove('rotate-90');
          content.style.maxHeight = '0px';
        }
      });
      hideSearchMessage();
    }

    initAnimatedAccordion();

    if (searchInput && searchButton) {
      const performSearch = () => searchInContent(searchInput.value.trim().toLowerCase());
      searchButton.addEventListener('click', performSearch);
      searchInput.addEventListener('keypress', e => { if (e.key === 'Enter') performSearch(); });
      searchInput.addEventListener('input', () => { if (searchInput.value.trim() === '') resetSearch(); });
    }
  });
</script>
{{ end }}