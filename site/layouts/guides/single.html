{{ define "main" }}
<section class="pt-[20px] md:pt-[25px] lg:pt-[40px] bg-white">
  <div class="max-w-[1280px] mx-auto px-[20px]">
    <div
      class="mb-[15px] md:mb-[33px] flex flex-col sm:flex-row sm:items-center sm:justify-between font-[Montserrat] gap-[7px]">
      <div class="flex flex-wrap items-center">
        <a class="font-[Montserrat] text-[16px] lg:text-[20px] font-normal text-[#ba0108] hover:underline leading-[120%]" href="/">
          Головна
        </a>
        <span class="text-[#ba0108] sm:inline px-[5px]">&rarr;</span>
        <a class="font-[Montserrat] text-[16px] lg:text-[20px]  font-normal text-[#ba0108] hover:underline leading-[120%]"
          href="/knowledge-base">
          База знань
        </a>
        <span class="text-[#ba0108] sm:inline px-[5px]">&rarr;</span>
        <a class="font-[Montserrat] text-[16px] lg:text-[20px] font-light md:font-normal text-[#ba0108] hover:underline break-words hyphens-auto leading-[120%]"
          href="#">
          {{ .Title }}
        </a>
      </div>

      <!-- Back button for mobile -->
      <div class="flex justify-end items-center sm:hidden">
        <button
          class="font-[Montserrat] text-[clamp(16px,2vw,18px)] font-normal text-black flex items-center gap-[clamp(8px,2vw,8px)] cursor-pointer">
          <span class="text-black">&lt;</span>
          Назад
        </button>
      </div>

      <!-- Search for tablets -->
      <div class="hidden sm:flex relative max-w-[clamp(250px,30vw,300px)] justify-center items-center lg:hidden">
        <div class="flex flex-1 items-center">
          <div class="relative flex-1 rounded-[20px]">
            <input type="text" placeholder="Введіть текст"
              class="h-[41px] w-full !rounded-[20px] border border-black pl-[clamp(12px,2vw,16px)] pr-[clamp(100px,15vw,120px)] text-[clamp(14px,2vw,16px)] outline-none focus:border-[#ba0108] bg-white" />
            <button
              class="absolute z-10 right-0 top-1/2 -translate-y-1/2 w-[70px] h-[41px] rounded-[20px] bg-[#ba0108] flex items-center justify-center cursor-pointer hover:bg-[#a00007] transition-colors">
              <img src="/img/search-icon.svg" alt="search" width="30" height="30" class="filter brightness-0 invert" />
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-[1fr_250px] lg:grid-cols-[280px_1fr_220px] gap-[clamp(20px,4vw,24px)]">
      <div class="bg-[#F6F6F6] max-w-[285px] h-full rounded-[5px] hidden lg:block">
        <aside class="relative pt-0 pr-0 pl-0">
          <div class="p-0">
            <nav id="left-category-nav" class="pt-[8px] fixed space-y-[20px]" style="width: 285px; max-height: calc(100vh - 200px); overflow-y: auto;">
              {{ $categories := slice "БПЛА" "Політні стеки" "Відеопередавачі" "ESC" }}
              {{ $guides := where .Site.RegularPages "Section" "guides" }}
              {{ range $index, $category := $categories }}
              {{ $categoryGuides := where $guides ".Params.category" $category }}
              <details class="asideDetails" {{ if eq $category $.Params.category }}open{{ end }}>
                <summary class="flex justify-between items-center px-[25px]">
                  <span class="font-[Montserrat] font-normal text-[20px] text-[#404040]">
                    {{ $category }}
                  </span>
                  <img src="/img/arrow.svg" alt="" width="18" height="18" class="asideIcon" />
                </summary>
                {{ if $categoryGuides }}
                <ul class="flex flex-col gap-[20px] b-l b-[#e0e0e0] ml-[36px] pr-[10px] !mt-[16px] max-w-[240px]"
                  style="border-left: 1px solid #e0e0e0; margin-left: 36px; padding-left: 16px;  padding-right: 10px; ">
                  {{ range $categoryGuides }}
                  <li>
                    <a href="{{ .Permalink }}"
                      class="block text-[16px] font-normal font-[Montserrat] {{ if eq .Title $.Title }}text-[#ba0108]{{ else }}hover:text-[#ba0108] transition-colors{{ end }}">
                      {{ .Title }}
                    </a>
                  </li>
                  {{ end }}
                </ul>
                {{ end }}
              </details>
              {{ end }}
            </nav>
          </div>
        </aside>
      </div>

      <div class="max-w-[min(693px,90vw)] min-h-0  pb-[40px] pt-0 lg:pt-[27px]">
        <div class="hidden lg:flex relative max-w-[min(691px,90vw)] justify-center items-center mb-[28px]">
          <div class="flex flex-1 items-center">
            <div class="relative flex-1 rounded-[20px]">
              <input type="text" placeholder="Введіть текст"
                class="h-[clamp(40px,6vw,47px)] w-full !rounded-[20px] border border-black pl-[clamp(12px,2vw,16px)] pr-[clamp(100px,15vw,120px)] text-[16px] outline-none focus:border-[#ba0108] bg-white" />
              <button
                class="absolute z-10 right-0 top-1/2 -translate-y-1/2 w-[clamp(80px,12vw,99px)] h-[clamp(40px,6vw,47px)] rounded-[20px] bg-[#ba0108] flex items-center justify-center cursor-pointer hover:bg-[#a00007] transition-colors">
                <img src="/img/search-icon.svg" alt="search" width="48" height="48"
                  class="filter brightness-0 invert" />
              </button>
            </div>
          </div>
        </div>
{{ if .Params.image }}
<div class="relative overflow-hidden rounded-xl border border-[#E5E5E5]">
  {{/* --- ДЕСКТОПНЕ ЗОБРАЖЕННЯ (з front matter) --- */}}
  {{ $customImage := resources.Get .Params.image }}
  {{ if $customImage }}
  {{ $desktop1x := $customImage.Resize "900x webp q80" }}
  {{ $desktop2x := $customImage.Resize "1800x webp q80" }}
  <img src="{{ $desktop1x.RelPermalink }}" srcset="{{ $desktop1x.RelPermalink }} 1x, {{ $desktop2x.RelPermalink }} 2x"
    alt="{{ .Title }}" class="hidden w-full h-auto sm:block" {{/* <-- ОСНОВНА ЗМІНА: h-auto */}}
    width="{{ $customImage.Width }}" height="{{ $customImage.Height }}" loading="lazy" decoding="async" />
  {{ end }}

  {{/* --- МОБІЛЬНЕ ЗОБРАЖЕННЯ (використовуємо спеціальний мобільний файл) --- */}}
  {{ $droneManMobile := resources.Get "img/drone-man-mobile.png" }}
  {{ if $droneManMobile }}
  {{ $mobile1x := $droneManMobile.Resize "480x webp q80" }}
  {{ $mobile2x := $droneManMobile.Resize "960x webp q80" }}
  <img src="{{ $mobile1x.RelPermalink }}" srcset="{{ $mobile1x.RelPermalink }} 1x, {{ $mobile2x.RelPermalink }} 2x"
    alt="{{ .Title }}" class="w-full h-auto sm:hidden" {{/* <-- ОСНОВНА ЗМІНА: h-auto */}}
    width="{{ $droneManMobile.Width }}" height="{{ $droneManMobile.Height }}" decoding="async" />
  {{ end }}
</div>
{{ else }}
<div class="relative overflow-hidden rounded-xl border border-[#E5E5E5]">
  {{/* --- ДЕСКТОПНЕ ЗОБРАЖЕННЯ (за замовчуванням) --- */}}
  {{ $droneMan := resources.Get "img/drone-man.png" }}
  {{ if $droneMan }}
  {{ $desktop1x := $droneMan.Resize "900x webp q80" }}
  {{ $desktop2x := $droneMan.Resize "1800x webp q80" }}
  <img src="{{ $desktop1x.RelPermalink }}" srcset="{{ $desktop1x.RelPermalink }} 1x, {{ $desktop2x.RelPermalink }} 2x"
    alt="Drone Man" class="hidden w-full h-auto sm:block" {{/* <-- ОСНОВНА ЗМІНА: h-auto */}}
    width="{{ $droneMan.Width }}" height="{{ $droneMan.Height }}" loading="lazy" decoding="async" />
  {{ end }}

  {{/* --- МОБІЛЬНЕ ЗОБРАЖЕННЯ (за замовчуванням) --- */}}
  {{ $droneManMobile := resources.Get "img/drone-man-mobile.png" }}
  {{ if $droneManMobile }}
  {{ $mobile1x := $droneManMobile.Resize "480x webp q80" }}
  {{ $mobile2x := $droneManMobile.Resize "960x webp q80" }}
  <img src="{{ $mobile1x.RelPermalink }}" srcset="{{ $mobile1x.RelPermalink }} 1x, {{ $mobile2x.RelPermalink }} 2x"
    alt="Drone Man" class="w-full h-auto sm:hidden" {{/* <-- ОСНОВНА ЗМІНА: h-auto */}}
    width="{{ $droneManMobile.Width }}" height="{{ $droneManMobile.Height }}" decoding="async" />
  {{ end }}
</div>
{{ end }}

        <div class="mt-[30px] markdown-content">
          {{ .Content }}
        </div>
      </div>

      <aside class="hidden relative md:block pt-0 lg:pt-[27px]">
        <nav>
          <div class="h-full">
            <nav  id="right-toc-nav" class="fixed" style="width: 200px; max-height: calc(100vh - 200px); overflow-y: auto;">
              <h4 class="font-[Montserrat] text-[16px] font-medium text-[#ba0108] mb-[20px]">
                На цій сторінці
              </h4>
              <ul class="space-y-[20px] text-[16px] font-normal font-[Montserrat]" id="page-toc">
                <!-- Table of contents will be generated by JavaScript -->
              </ul>
            </nav>
          </div>
        </nav>
      </aside>
    </div>
  </div>
</section>

<style>
  .asideDetails summary {
    list-style: none;
  }

  .asideDetails summary::-webkit-details-marker {
    display: none;
  }

  .asideIcon {
    transform: rotate(-90deg);
    transition: transform 200ms ease;
    cursor: pointer;
    filter: brightness(0) saturate(100%);
    opacity: 0.5;
  }

  .asideDetails[open] .asideIcon {
    transform: rotate(0deg);
    opacity: 1;
  }

  .asideDetails[open] .asideIcon {
    filter: brightness(0) saturate(100%) invert(8%) sepia(100%) saturate(7482%) hue-rotate(357deg) brightness(95%) contrast(118%);
  }

  .asideDetails[open] summary span {
    color: #ba0108 !important;
  }

  .chevronRight {
    transform: rotate(-90deg);
    opacity: 0.8;
  }

  .contentScrollable {
    overflow-y: auto;
    scroll-behavior: smooth;
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  .contentScrollable::-webkit-scrollbar {
    width: 0;
    height: 0;
  }

  .bg-\[\#fafafa\] {
    overflow: hidden;
  }

  nav.fixed::-webkit-scrollbar {
    display: none;
  }

  nav.fixed {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  #markdown {
    border-radius: 10px;
    box-shadow: 0 4px 16px 0 rgba(0, 0, 0, 0.1);
    margin: 24px 0;
    max-width: 100%;
    height: auto;
  }

  .markdown-content h2 {
    font-family: 'Montserrat', sans-serif;
    font-size: 20px;
    line-height: 24px;
    font-weight: 400;
    border-bottom: 1px solid #ba0108;
    padding-bottom: 12px;
    margin-top: 32px;
    margin-bottom: 12px;
    color: #000;
  }

  .markdown-content h3 {
    font-family: 'Montserrat', sans-serif;
    font-size: 18px;
    font-weight: 400;
    margin-top: 24px;
    margin-bottom: 12px;
    color: #000;
  }

  .markdown-content p {
    font-family: 'Montserrat', sans-serif;
    font-size: 16px;
    line-height: 1.625;
    font-weight: 400;
    margin-bottom: 16px;
    color: #333;
  }

  .markdown-content ol {
    margin-bottom: 16px;
  }

  .markdown-content ol li {
    display: flex;
    gap: 12px;
    align-items: flex-start;
    margin-bottom: 16px;
    font-family: 'Montserrat', sans-serif;
    font-size: 16px;
    line-height: 18px;
    font-weight: 400;
    color: #333;
  }

  .markdown-content ol li::before {
    content: counter(list-item);
    counter-increment: list-item;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 35px;
    height: 35px;
    background-image: url('/img/list-guide-one.png');
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    flex-shrink: 0;
  }

  .markdown-content ol li:nth-child(2)::before {
    background-image: url('/img/list-guide-two.png');
  }

  .markdown-content ol li:nth-child(3)::before {
    background-image: url('/img/list-guide-three.png');
  }

  .markdown-content ol li:nth-child(4)::before {
    background-image: url('/img/list-guide-four.png');
  }

  .markdown-content ul {
    margin-bottom: 16px;
    padding-left: 20px;
  }

  .markdown-content ul li {
    font-family: 'Montserrat', sans-serif;
    font-size: 16px;
    line-height: 1.625;
    font-weight: 400;
    margin-bottom: 8px;
    color: #333;
    list-style-type: disc;
  }

  .markdown-content strong {
    font-weight: 600;
    color: #000;
  }

  .markdown-content em {
    font-style: italic;
  }

  .markdown-content a {
    color: #ba0108;
    text-decoration: underline;
  }

  .markdown-content a:hover {
    text-decoration: none;
  }


  .markdown-content blockquote {
    background-color: #f5f5f5;
    padding: 24px 29px;
    border-radius: 8px;
    margin: 24px 0;
    font-style: italic;
    color: #333;
  }

  .markdown-content code {
    background-color: #f3f4f6;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 14px;
    font-family: monospace;
  }

  .markdown-content pre {
    background-color: #111827;
    color: #f3f4f6;
    padding: 16px;
    border-radius: 8px;
    overflow-x: auto;
    margin-bottom: 16px;
  }

  /* Стилі для підчеркувань */
  .markdown-content .underline {
    text-decoration: underline;
  }

  .markdown-content .text-red {
    color: #ba0108;
  }

  .markdown-content section {
    margin-top: 40px;
    scroll-margin-top: 96px;
  }

  .markdown-content section:first-of-type {
    margin-top: 32px;
  }

  .markdown-content section.bg-gray {
    background-color: #f5f5f5;
    padding: 27px 29px;
    border-radius: 8px;
    margin: 40px 0;
  }

  .markdown-content section.shadow {
    max-width: 694px;
    height: 259px;
    padding: 22px 25px;
    margin: 40px 0 64px 0;
    border-radius: 10px;
    box-shadow: 0 4px 16px 0 rgba(0, 0, 0, 0.1);
  }



  @media (max-width: 768px) {
    .grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Generate table of contents
    const headings = document.querySelectorAll('.markdown-content h2, .markdown-content h3');
    const tocList = document.getElementById('page-toc');
    const leftSidebar = document.getElementById('left-category-nav');
    const rightSidebar = document.getElementById('right-toc-nav');
    const footer = document.getElementById('footer');

    if (footer && (leftSidebar || rightSidebar)) {
      const sidebarsToManage = [];

      if (leftSidebar) {
        sidebarsToManage.push({
          element: leftSidebar,
          initialTop: leftSidebar.getBoundingClientRect().top
        });
      }
      if (rightSidebar) {
        sidebarsToManage.push({
          element: rightSidebar,
          initialTop: rightSidebar.getBoundingClientRect().top
        });
      }
      const updateAllSidebarPositions = () => {
        const footerRect = footer.getBoundingClientRect();
        const viewportHeight = window.innerHeight;
        sidebarsToManage.forEach(sidebarData => {
          const { element, initialTop } = sidebarData; 
          if (footerRect.top < viewportHeight) {
            const overlap = viewportHeight - footerRect.top;
            element.style.top = `${initialTop - overlap}px`;
          } else {
            element.style.top = `${initialTop}px`;
          }
        });
      };
      window.addEventListener('scroll', updateAllSidebarPositions);
      window.addEventListener('resize', updateAllSidebarPositions);
      updateAllSidebarPositions();
    }


    if (tocList && headings.length > 0) {
      headings.forEach((heading, index) => {
        // Create ID for heading if it doesn't exist
        if (!heading.id) {
          heading.id = 'heading-' + index;
        }

        // Create TOC item
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = '#' + heading.id;
        a.textContent = heading.textContent;
        a.className = 'block hover:text-[#ba0108] transition-colors text-[16px] font-medium text-[#404040]';

        li.appendChild(a);
        tocList.appendChild(li);
      });
    }

    // Smooth scrolling for anchor links
    const anchorLinks = document.querySelectorAll('a[href^="#"]');
    anchorLinks.forEach((link) => {
      link.addEventListener('click', function (e) {
        e.preventDefault();
        const targetId = this.getAttribute('href').substring(1);
        const targetElement = document.getElementById(targetId);

        if (targetElement) {
          targetElement.scrollIntoView({
            behavior: 'smooth',
            block: 'start',
          });
        }
      });
    });

    // Highlight active section in TOC
    const sections = document.querySelectorAll('.markdown-content h2[id], .markdown-content h3[id]');
    const navLinks = document.querySelectorAll('#page-toc a[href^="#"]');

    function highlightActiveSection() {
      let current = '';
      sections.forEach((section) => {
        const sectionTop = section.offsetTop;
        if (window.pageYOffset >= sectionTop - 200) {
          current = section.getAttribute('id');
        }
      });

      navLinks.forEach((link) => {
        link.style.color = '';
        if (link.getAttribute('href') === '#' + current) {
          link.style.color = '#ba0108';
        }
      });
    }

    window.addEventListener('scroll', highlightActiveSection);
    highlightActiveSection();

  });
</script>
{{ end }}