{{ define "main" }}
<section class="pt-[20px] md:pt-[25px] lg:pt-[40px] bg-white relative">
    {{ $bgEl10 := resources.Get "img/bg-el-10.png" }}
    {{ if $bgEl10 }}
    {{ $bgEl10Desktop := $bgEl10.Resize "295x270 webp q80" }}
    <img fetchpriority="high" src="{{ $bgEl10Desktop.RelPermalink }}" alt="{{ i18n " kb.aria.bg" }}" aria-hidden="true"
      class="absolute hidden md:block z-[1] top-0 lg:top-[-1%] left-0 w-[191px] lg:w-[295px] h-auto" />
    {{ else }}
    <img fetchpriority="high" src="/img/bg-el-1.png" alt="{{ i18n " kb.aria.bg" }}" aria-hidden="true"
      class="absolute hidden md:block z-[1] top-0 lg:top-[-1%] left-0 w-[191px] lg:w-[295px] h-auto" />
    {{ end }}
    
    {{ $bgEl1 := resources.Get "img/bg-el-1.png" }}
    {{ if $bgEl1 }}
    {{ $bgEl1Processed := $bgEl1.Resize "201x webp q80" }}
    <img fetchpriority="high" src="{{ $bgEl1Processed.RelPermalink }}" alt="{{ i18n " kb.aria.bg" }}" aria-hidden="true"
      class="absolute block md:hidden z-[1] right-[-18%] top-[-54px] w-[201px] h-auto opacity-50" />
    {{ else }}
    <img fetchpriority="high" src="/img/bg-el-1.png" alt="{{ i18n " kb.aria.bg" }}" aria-hidden="true"
      class="absolute block md:hidden z-[1] right-[-18%] top-[-54px]  w-[201px] h-auto opacity-50" />
    {{ end }}

  <div class="max-w-[1280px] mx-auto px-[20px]">
    <div
      class="mb-[15px] md:mb-[33px] flex flex-col sm:flex-row sm:items-center sm:justify-between font-[Montserrat] gap-[7px]">
      <div class="flex flex-wrap items-center">
        <a class="font-[Montserrat] text-[16px] lg:text-[20px] font-normal text-[#ba0108] hover:underline leading-[120%]"
          href="/">
          {{ i18n "guides.breadcrumb.home" }}
        </a>
        <span class="text-[#ba0108] sm:inline px-[5px]">&rarr;</span>
        <a class="font-[Montserrat] text-[16px] lg:text-[20px]  font-normal text-[#ba0108] hover:underline leading-[120%]"
          href="{{ "/knowledge-base/" | relLangURL }}">{{ i18n "guides.breadcrumb.knowledge" }}
        </a>
        <span class="text-[#ba0108] sm:inline px-[5px]">&rarr;</span>
        <span
          class="font-[Montserrat] text-[16px] lg:text-[20px] font-light md:font-normal text-[#ba0108] break-words hyphens-auto leading-[120%]">
          {{ .Title }}
        </span>
      </div>
      <div class="flex justify-between items-center">
        <div class="flex justify-end items-center sm:hidden">
          <button
            class="font-[Montserrat] text-[clamp(16px,2vw,18px)] font-normal text-black flex items-center gap-[clamp(8px,2vw,8px)] cursor-pointer">
            <a href="{{ "/knowledge-base/" | relLangURL }}">
              <span class="text-black">&lt;</span>
              {{ i18n "guides.back" }}
            </a>
          </button>
        </div>

        <!-- Search for tablets and mobile -->
        <div class="flex relative max-w-[clamp(250px,30vw,300px)] justify-center items-center lg:hidden">
          <div class="flex flex-1 items-center">
            <div class="relative flex-1 rounded-[20px]">
              <input type="text" placeholder="{{ i18n "guides.search.placeholder" }}"
                class="h-[41px] w-full !rounded-[20px] border border-black pl-[clamp(12px,2vw,16px)] pr-[clamp(100px,15vw,120px)] text-[clamp(14px,2vw,16px)] outline-none focus:border-[#ba0108] bg-white"
                id="tablet-search-input" />
              <button
                class="absolute z-10 right-0 top-1/2 -translate-y-1/2 w-[70px] h-[41px] rounded-[20px] bg-[#ba0108] flex items-center justify-center cursor-pointer hover:bg-[#a00007] transition-colors"
                id="tablet-search-button">
                <img src="/img/search-icon.svg" alt="search" width="30" height="30"
                  class="filter brightness-0 invert" />
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Back button for mobile -->

    </div>

    <div class="grid grid-cols-1 md:grid-cols-[1fr_250px] lg:grid-cols-[280px_1fr_220px] gap-[clamp(20px,4vw,24px)]">
      <!-- Left sidebar - Categories -->
      <div class="bg-[#F6F6F6] max-w-[285px] h-full rounded-[5px] hidden lg:block">
        <aside class="relative pt-0 pr-0 pl-0">
          <div class="p-0">
            <nav id="left-category-nav" class="pt-[20px] fixed space-y-[20px]"
              style="width: 285px; max-height: calc(100vh - 200px); overflow-y: auto;">
              {{- $currentLang := .Site.Language.Lang -}}
              {{- $allCats := slice -}}
              {{- range site.Sites -}}
              {{- $allCats = $allCats | append (where .RegularPages "Section" "categories") -}}
              {{- end -}}
              {{- $byBase := dict -}}
              {{- range $allCats -}}
              {{- $base := .File.TranslationBaseName -}}
              {{- $existing := index $byBase $base -}}
              {{- if not $existing -}}
              {{- $byBase = merge $byBase (dict $base .) -}}
              {{- else if eq .Lang $currentLang -}}
              {{- $byBase = merge $byBase (dict $base .) -}}
              {{- end -}}
              {{- end -}}
              {{- $categories := slice -}}
              {{- range $k, $v := $byBase -}}
              {{- $categories = $categories | append $v -}}
              {{- end -}}
              {{- $categories = sort $categories "Params.weight" "asc" "Title" "asc" -}}

              {{- $allGuides := slice -}}
              {{- range site.Sites -}}
              {{- $allGuides = $allGuides | append (where .RegularPages "Section" "guides") -}}
              {{- end -}}
              {{- $byGuideBase := dict -}}
              {{- range $allGuides -}}
              {{- $gbase := .File.TranslationBaseName -}}
              {{- $gexisting := index $byGuideBase $gbase -}}
              {{- if not $gexisting -}}
              {{- $byGuideBase = merge $byGuideBase (dict $gbase .) -}}
              {{- else if eq .Lang $currentLang -}}
              {{- $byGuideBase = merge $byGuideBase (dict $gbase .) -}}
              {{- end -}}
              {{- end -}}
              {{- $guides := slice -}}
              {{- range $k, $v := $byGuideBase -}}
              {{- $guides = $guides | append $v -}}
              {{- end -}}

              {{ range $index, $cat := $categories }}
              {{- $categorySlug := $cat.File.TranslationBaseName -}}
              {{- $categoryTitle := $cat.Title -}}

              {{- $bySlug := where $guides ".Params.category" $categorySlug -}}
              {{- $byTitle := where $guides ".Params.category" $categoryTitle -}}
              {{- $byCategorySlug := where $guides ".Params.category" $cat.Params.slug -}}

              {{- $searchTerms := slice $categoryTitle $categorySlug -}}
              {{- if $cat.Params.slug -}}
              {{- $searchTerms = $searchTerms | append $cat.Params.slug -}}
              {{- end -}}
              {{- if $cat.Params.aliases -}}
              {{- range $cat.Params.aliases -}}
              {{- $alias := . -}}
              {{- $searchTerms = $searchTerms | append $alias -}}
              {{- if not (hasPrefix $alias "-") -}}
              {{- $searchTerms = $searchTerms | append (printf "-%s" $alias) -}}
              {{- end -}}
              {{- end -}}
              {{- end -}}
              {{- $byAliases := where $guides ".Params.category" "in" $searchTerms -}}

              {{- $categoryGuides := union $bySlug (union $byTitle (union $byCategorySlug $byAliases)) -}}
              <details class="asideDetails" {{ if or (eq $.Params.category $categorySlug) (eq $.Params.category
                $categoryTitle) (in $searchTerms $.Params.category) }}open{{ end }}>
                <summary class="flex justify-between items-center px-[25px]">
                  <span class="font-[Montserrat] font-normal text-[20px] text-[#404040]">
                    {{ $cat.Title }}
                  </span>
                  <img src="/img/arrow.svg" alt="" width="18" height="18" class="asideIcon" />
                </summary>
                {{ if $categoryGuides }}
                <ul class="flex flex-col gap-[10px] b-l b-[#e0e0e0] ml-[36px] pr-[10px] !mt-[16px] max-w-[240px]" style="
                    border-left: 1px solid #e0e0e0;
                    margin-left: 36px;
                    padding-left: 16px;
                    padding-right: 10px;
                  ">
                  {{ range $categoryGuides }}
                  <li>
                    <a href="{{ .RelPermalink }}"
                      class="block text-[16px] font-normal font-[Montserrat] {{ if eq .Title $.Title }}text-[#ba0108]{{ else }}hover:text-[#ba0108] transition-colors{{ end }}">
                      {{ .Title }}
                    </a>
                  </li>
                  {{ end }}
                </ul>
                {{ end }}
              </details>
              {{ end }}
            </nav>
          </div>
        </aside>
      </div>

      <div class="max-w-[min(693px,90vw)] min-h-0 pb-[40px] pt-0 lg:pt-[27px]">
        <div class="hidden lg:flex relative max-w-[min(691px,90vw)] justify-center items-center mb-[28px]">
          <div class="flex flex-1 items-center">
            <div class="relative flex-1 rounded-[20px]">
              <input type="text" placeholder="{{ i18n " guides.placeholder" }}"
                class="h-[clamp(40px,6vw,47px)] w-full !rounded-[20px] border border-black pl-[clamp(12px,2vw,16px)] pr-[clamp(100px,15vw,120px)] text-[16px] outline-none focus:border-[#ba0108] bg-white"
                id="desktop-search-input" />
              <button
                class="absolute z-10 right-0 top-1/2 -translate-y-1/2 w-[clamp(80px,12vw,99px)] h-[clamp(40px,6vw,47px)] rounded-[20px] bg-[#ba0108] flex items-center justify-center cursor-pointer hover:bg-[#a00007] transition-colors"
                id="desktop-search-button">
                <img src="/img/search-icon.svg" alt="search" width="48" height="48"
                  class="filter brightness-0 invert" />
              </button>
            </div>
          </div>
        </div>
        {{ if .Params.image }}
        <div class="relative overflow-hidden rounded-xl border border-[#E5E5E5]">
          {{ $customImage := resources.Get .Params.image }}
          {{ if $customImage }}
          {{ $desktop1x := $customImage.Fill "690x400 webp q85" }}
          {{ $desktop2x := $customImage.Fill "1380x800 webp q85" }}
          {{ $mobile1x := $customImage.Fill "480x300 webp q85" }}
          {{ $mobile2x := $customImage.Fill "960x600 webp q85" }}
          <img src="{{ $desktop1x.RelPermalink }}"
            srcset="{{ $desktop1x.RelPermalink }} 1x, {{ $desktop2x.RelPermalink }} 2x" alt="{{ .Title }}"
            class="hidden w-full h-auto sm:block" width="690" height="400" loading="lazy" decoding="async" />
          <img src="{{ $mobile1x.RelPermalink }}"
            srcset="{{ $mobile1x.RelPermalink }} 1x, {{ $mobile2x.RelPermalink }} 2x" alt="{{ .Title }}"
            class="w-full h-auto sm:hidden" width="480" height="300" loading="lazy" decoding="async" />
          {{ else }}
          <img src="{{ .Params.image }}" alt="{{ .Title }}" class="w-full h-auto" loading="lazy" decoding="async" />
          {{ end }}
        </div>
        {{ end }}

        <h1 class="md:!text-[32px] !text-[24px] font-[Unbounded] !py-[10px] font-medium">
          {{ .Title }}
        </h1>

        <!-- Search Results -->
        <div id="search-results" class="hidden mb-6">
          <div id="search-results-list" class="space-y-4"></div>
        </div>

        <div class="markdown-content" id="article-content">{{ .Content }}</div>
      </div>

      <!-- Right sidebar - TOC -->
      <aside class="hidden lg:block pt-0 lg:pt-[27px]" style="width:220px;">
        <nav id="right-toc-nav" style="
          position: fixed;
          top: 172px;                 
          right: calc((100% - 1280px) / 2);  
          width: 220px;
          max-height: calc(100vh - 160px);
          overflow-y: auto;
        ">
          <h4 class="font-[Montserrat] text-[16px] font-medium text-[#ba0108] mb-[20px]">
            {{ i18n "guides.toc.title" }}
          </h4>
          <ul class="space-y-[20px] text-[16px] font-normal font-[Montserrat]" id="page-toc"></ul>
        </nav>
      </aside>
    </div>
  </div>
</section>

<style>
  .asideDetails summary {
    list-style: none;
  }

  .asideDetails summary::-webkit-details-marker {
    display: none;
  }

  .asideIcon {
    transform: rotate(-90deg);
    transition: transform 200ms ease;
    cursor: pointer;
    filter: brightness(0) saturate(100%);
    opacity: 0.5;
  }

  .asideDetails[open] .asideIcon {
    transform: rotate(0deg);
    opacity: 1;
  }

  .asideDetails[open] .asideIcon {
    filter: brightness(0) saturate(100%) invert(8%) sepia(100%) saturate(7482%) hue-rotate(357deg) brightness(95%) contrast(118%);
  }

  .asideDetails[open] summary span {
    color: #ba0108 !important;
  }

  .chevronRight {
    transform: rotate(-90deg);
    opacity: 0.8;
  }

  .contentScrollable {
    overflow-y: auto;
    scroll-behavior: smooth;
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  .contentScrollable::-webkit-scrollbar {
    width: 0;
    height: 0;
  }

  .bg-```math \#fafafa``` {
    overflow: hidden;
  }

  nav.fixed::-webkit-scrollbar {
    display: none;
  }

  nav.fixed {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }

  @media (max-width: 768px) {
    .grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const headings = document.querySelectorAll(
      ".markdown-content h2, .markdown-content h3"
    );
    const tocList = document.getElementById("page-toc");

    if (tocList && headings.length > 0) {
      headings.forEach((heading, index) => {
        if (!heading.id) {
          heading.id = "heading-" + index;
        }
        const li = document.createElement("li");
        const a = document.createElement("a");
        a.href = "#" + heading.id;
        a.textContent = heading.textContent;
        a.className =
          "block hover:text-[#ba0108] transition-colors text-[16px] font-medium text-[#404040]";
        li.appendChild(a);
        tocList.appendChild(li);
      });
    }
    const leftSidebar = document.getElementById("left-category-nav");
    const rightSidebar = document.getElementById("right-toc-nav");
    const footer = document.querySelector("footer");

    if (footer && (leftSidebar || rightSidebar)) {
      const sidebarsToManage = [];
      if (leftSidebar) {
        sidebarsToManage.push({
          element: leftSidebar,
          parent: leftSidebar.closest("aside"),
          naturalTop: leftSidebar.getBoundingClientRect().top,
        });
      }
      if (rightSidebar) {
        sidebarsToManage.push({
          element: rightSidebar,
          parent: rightSidebar.closest("aside"),
          naturalTop: rightSidebar.getBoundingClientRect().top,
        });
      }

      if (sidebarsToManage.length === 0) return;

      const bottomMargin = 40;

      const updateSidebarPositions = () => {
        const footerTop = footer.getBoundingClientRect().top;
        sidebarsToManage.forEach((data) => {
          const { element, parent, naturalTop } = data;
          if (!parent) return;
          const sidebarHeight = element.offsetHeight;
          if (footerTop < naturalTop + sidebarHeight + bottomMargin) {
            element.style.position = "absolute";
            const parentTop = parent.getBoundingClientRect().top;
            const newTop = footerTop - parentTop - sidebarHeight - bottomMargin;

            element.style.top = `${newTop}px`;
            element.style.bottom = "auto";
          } else {
            element.style.position = "fixed";
            element.style.top = `${naturalTop}px`;
            element.style.bottom = "auto";
          }
        });
      };
      window.addEventListener("scroll", updateSidebarPositions);
      window.addEventListener("resize", updateSidebarPositions);
      updateSidebarPositions();
    }
    const anchorLinks = document.querySelectorAll('a[href^="#"]');
    anchorLinks.forEach((link) => {
      link.addEventListener("click", function (e) {
        e.preventDefault();
        const targetId = this.getAttribute("href").substring(1);
        const targetElement = document.getElementById(targetId);
        if (targetElement) {
          targetElement.scrollIntoView({ behavior: "smooth", block: "start" });
        }
      });
    });
    const sections = document.querySelectorAll(
      ".markdown-content h2[id], .markdown-content h3[id]"
    );
    const navLinks = document.querySelectorAll('#page-toc a[href^="#"]');

    function highlightActiveSection() {
      let current = "";
      sections.forEach((section) => {
        const sectionTop = section.offsetTop;
        if (window.pageYOffset >= sectionTop - 200) {
          current = section.getAttribute("id");
        }
      });
      navLinks.forEach((link) => {
        link.style.color = "";
        if (link.getAttribute("href") === "#" + current) {
          link.style.color = "#ba0108";
        }
      });
    }

    window.addEventListener("scroll", highlightActiveSection);
    highlightActiveSection();
  });

  // Article Content Search Functionality
  document.addEventListener("DOMContentLoaded", function () {
    const desktopSearchInput = document.getElementById('desktop-search-input');
    const desktopSearchButton = document.getElementById('desktop-search-button');
    const tabletSearchInput = document.getElementById('tablet-search-input');
    const tabletSearchButton = document.getElementById('tablet-search-button');
    const searchResults = document.getElementById('search-results');
    const searchResultsList = document.getElementById('search-results-list');

    let searchResultsData = [];

    function clearSearch() {
      if (searchResultsList) searchResultsList.innerHTML = '';
      searchResultsData = [];

      const existingTitle = searchResults.querySelector('h3');
      if (existingTitle) {
        existingTitle.remove();
      }

      document.querySelectorAll('span[id^="temp-search-result-"]').forEach(marker => {
        if (marker.parentNode) marker.replaceWith(document.createTextNode(marker.textContent));
      });

      const mainContent = document.querySelector('main') || document.body;
      if (mainContent) mainContent.normalize();
    }

    function executeSearch() {
      clearSearch();

      const query = (desktopSearchInput?.value || tabletSearchInput?.value || '').trim();
      if (query.length < 2) {
        searchResults.classList.add('hidden');
        return;
      }

      const regex = new RegExp(`(${query.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'gi');
      let resultIndex = 0;

      const mainContent = document.querySelector('main') || document.body;
      if (!mainContent) return;

      const walker = document.createTreeWalker(mainContent, NodeFilter.SHOW_TEXT, {
        acceptNode: node => (node.parentNode.closest('script, style, header, footer, #search-results') || !node.textContent.trim() || !regex.test(node.textContent)) ? NodeFilter.FILTER_REJECT : NodeFilter.FILTER_ACCEPT
      });

      const nodesToProcess = [];
      while (walker.nextNode()) nodesToProcess.push(walker.currentNode);

      nodesToProcess.forEach(textNode => {
        const fragment = document.createDocumentFragment();
        let lastIndex = 0;
        textNode.textContent.replace(regex, (match, ...args) => {
          const offset = args[args.length - 2];
          if (offset > lastIndex) fragment.appendChild(document.createTextNode(textNode.textContent.substring(lastIndex, offset)));
          const markerSpan = document.createElement('span');
          const resultId = `temp-search-result-${resultIndex++}`;
          markerSpan.id = resultId;
          markerSpan.textContent = match;
          markerSpan.className = 'bg-yellow-200 font-semibold';
          fragment.appendChild(markerSpan);
          searchResultsData.push({
            id: resultId,
            context: getContext(textNode.textContent, match, offset)
          });
          lastIndex = offset + match.length;
        });
        if (lastIndex < textNode.textContent.length) fragment.appendChild(document.createTextNode(textNode.textContent.substring(lastIndex)));
        textNode.parentNode.replaceChild(fragment, textNode);
      });

      displayResults();
    }

    function getContext(fullText, match, matchIndex) {
      const contextLength = 60;
      const start = Math.max(0, matchIndex - contextLength);
      const end = Math.min(fullText.length, matchIndex + match.length + contextLength);
      let context = (start > 0 ? '...' : '') + fullText.substring(start, end) + (end < fullText.length ? '...' : '');
      return context.replace(new RegExp(`(${match})`, 'gi'), '<span class="text-[#ba0108] font-semibold">$1</span>');
    }

    function displayResults() {
      if (!searchResultsList) return;
      searchResultsList.innerHTML = '';

      if (searchResultsData.length > 0) {
        searchResults.classList.remove('hidden');

        const titleElement = document.createElement('h3');
        titleElement.className = 'font-[Montserrat] text-xl font-semibold mb-4 text-[#ba0108]';
        titleElement.textContent = '{{ i18n "guides.search.results" }}';
        searchResults.insertBefore(titleElement, searchResultsList);

        searchResultsData.forEach(result => {
          const resultElement = document.createElement('div');
          resultElement.className = 'block p-3 text-gray-800 bg-gray-50 hover:bg-gray-100 rounded-md my-1 text-sm cursor-pointer border-l-4 border-[#ba0108]';
          resultElement.innerHTML = `<div>${result.context}</div>`;
          resultElement.addEventListener('click', () => scrollToResultOrNavigate(result.id));
          searchResultsList.appendChild(resultElement);
        });
      } else {
        searchResults.classList.add('hidden');
      }
    }

    function scrollToResultOrNavigate(resultId) {
      const element = document.getElementById(resultId);
      if (!element) return;

      const linkElement = element.closest('a');

      if (linkElement && linkElement.href) {
        window.location.href = linkElement.href;
      } else {
        const parentBlock = element.closest('p, li, h1, h2, h3, h4, td, th, div:not(:empty)');
        element.scrollIntoView({ behavior: 'smooth', block: 'center' });

        if (parentBlock) {
          parentBlock.style.backgroundColor = 'rgba(186, 1, 8, 0.1)';
          setTimeout(() => {
            parentBlock.style.backgroundColor = '';
            clearSearch();
            if (desktopSearchInput) desktopSearchInput.value = '';
            if (tabletSearchInput) tabletSearchInput.value = '';
          }, 2000);
        } else {
          clearSearch();
          if (desktopSearchInput) desktopSearchInput.value = '';
          if (tabletSearchInput) tabletSearchInput.value = '';
        }
      }
    }

    function scrollToResult(resultId) {
      scrollToResultOrNavigate(resultId);
    }

    function syncSearchInputs(sourceInput, targetInput) {
      if (sourceInput && targetInput) {
        sourceInput.addEventListener('input', (event) => {
          targetInput.value = event.target.value;
          if (event.target.value.length === 0) {
            clearSearch();
            searchResults.classList.add('hidden');
          }
        });
      }
    }

    syncSearchInputs(desktopSearchInput, tabletSearchInput);
    syncSearchInputs(tabletSearchInput, desktopSearchInput);

    if (desktopSearchInput && desktopSearchButton) {
      desktopSearchButton.addEventListener('click', executeSearch);
      desktopSearchInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
          event.preventDefault();
          executeSearch();
        }
      });
    }

    if (tabletSearchInput && tabletSearchButton) {
      tabletSearchButton.addEventListener('click', executeSearch);
      tabletSearchInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
          event.preventDefault();
          executeSearch();
        }
      });
    }
  });
</script>
{{ end }}