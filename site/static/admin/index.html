<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>

<body>
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  <script src="/admin/config.js" type="module"></script>

  <script>
    if (window.netlifyIdentity) {
      window.netlifyIdentity.on("init", user => {
        if (!user) {
          window.netlifyIdentity.on("login", () => {
            document.location.href = "/admin/";
          });
        }
      });
    }


    function slugify(str) {
      return str
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "") 
        .replace(/[^a-zA-Z0-9\s-]/g, "") 
        .trim()
        .toLowerCase()
        .replace(/\s+/g, "-");
    }


    CMS.registerEventListener({
      name: "preSave",
      handler: ({ entry }) => {
        const data = entry.get("data");
        const collection = entry.get("collection");

        if (collection === "categories") {
          const title = data.getIn(["title", "en"]) || data.get("title") || "";
          if (title) {
            const newSlug = slugify(title);
            entry = entry.setIn(["data", "slug"], newSlug);
            console.log("Slug згенеровано:", newSlug);
          }
        }

        return entry;
      },
    });

    CMS.registerEditorComponent({
      id: "figure",
      label: "Figure Image",
      fields: [
        { name: "src", label: "Image", widget: "image" },
        { name: "alt", label: "Alt Text", widget: "string" },
        { name: "caption", label: "Caption", widget: "string", required: false },
        { name: "align", label: "Align", widget: "select", options: ["left", "right", "center"], default: "right" },
        { name: "width", label: "Container Width", widget: "string", required: false, default: "40%" },
        { name: "img_width", label: "Image Width", widget: "string", required: false, default: "100%" },
        { name: "class", label: "Extra CSS classes", widget: "string", required: false }
      ],
      pattern: /^\{\{< figure src="([^"]+)"(?: alt="([^"]*)")?(?: caption="([^"]*)")?(?: align="([^"]*)")?(?: width="([^"]*)")?(?: img_width="([^"]*)")?(?: class="([^"]*)")? >\}\}$/,
      fromBlock: function (match) {
        return {
          src: match[1],
          alt: match[2],
          caption: match[3],
          align: match[4],
          width: match[5],
          img_width: match[6],
          class: match[7]
        };
      },
      toBlock: function (obj) {
        let shortcode = `{{< figure src="${obj.src}"`;
        if (obj.alt) shortcode += ` alt="${obj.alt}"`;
        if (obj.caption) shortcode += ` caption="${obj.caption}"`;
        if (obj.align) shortcode += ` align="${obj.align}"`;
        if (obj.width) shortcode += ` width="${obj.width}"`;
        if (obj.img_width) shortcode += ` img_width="${obj.img_width}"`;
        if (obj.class) shortcode += ` class="${obj.class}"`;
        shortcode += " >}}";
        return shortcode;
      },
      toPreview: function (obj) {
        let figureStyle = `margin: 10px; width: ${obj.width || '40%'};`;
        if (obj.align === 'left' || obj.align === 'right') {
          figureStyle += ` float: ${obj.align};`;
        } else if (obj.align === 'center') {
          figureStyle += ` display: block; margin-left: auto; margin-right: auto;`;
        }

        const imgStyle = `max-width: 100%; width: ${obj.img_width || '100%'}; margin-bottom: 8px; object-fit: contain; display: inline-block;`;

        return `
          <figure style="${figureStyle}">
            <img src="${obj.src}" alt="${obj.alt || ''}" style="${imgStyle}">
            ${obj.caption ? `<figcaption style="margin-top: 4px; font-size: 0.875rem; text-align: center; color: #6b7280;">${obj.caption}</figcaption>` : ''}
          </figure>
        `;
      }
    });


    const getYouTubeId = (url) => {
      if (!url || typeof url !== 'string') return '';
      const regExp = /^.*(?:youtu.be\/|v\/|e\/|watch\?v=|\&v=|\/embed\/)([^"&?\/\s]{11}).*$/;
      const match = url.match(regExp);
      return (match && match[1].length === 11) ? match[1] : '';
    };

    CMS.registerEditorComponent({
      id: "youtube",
      label: "YouTube Video",
      fields: [
        { name: "url", label: "Посилання на YouTube", widget: "string", required: true },
        { name: "caption", label: "Підпис", widget: "string", required: false },
        { name: "width", label: "Ширина", widget: "string", required: false, default: "100%" }
      ],
      pattern: /^\{\{< youtube id="([^"]+)"(?: caption="([^"]*)")?(?: width="([^"]*)")? >\}\}$/,
      fromBlock: match => ({
        url: match[1] ? `https://www.youtube.com/watch?v=${match[1]}` : '',
        caption: match[2],
        width: match[3],
      }),
      toBlock: obj => {
        const videoId = getYouTubeId(obj.url);
        if (!videoId) return '';
        let shortcode = `{{< youtube id="${videoId}"`;
        if (obj.caption) shortcode += ` caption="${obj.caption}"`;
        if (obj.width && obj.width !== "100%") shortcode += ` width="${obj.width}"`;
        shortcode += " >}}";
        return shortcode;
      },
      toPreview: obj => {
        const videoId = getYouTubeId(obj.url);
        if (!videoId) return `<div>❌ Недійсне посилання</div>`;
        return `
          <figure style="width: ${obj.width || '100%'}; max-width: 100%;">
            <div style="position: relative; padding-bottom: 56.25%; height: 0;">
              <iframe src="https://www.youtube.com/embed/${videoId}" style="position: absolute; top:0; left:0; width:100%; height:100%;" allowfullscreen></iframe>
            </div>
            ${obj.caption ? `<figcaption style="text-align:center;">${obj.caption}</figcaption>` : ''}
          </figure>
        `;
      }
    });
  </script>
</body>

</html>